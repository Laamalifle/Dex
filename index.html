<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Laam wallet</title>
<script src="main.js"></script>
    <!-- Favicon & OG Image -->
    <link rel="icon" type="image/png" href="https://i.ibb.co/r28SP1bN/20250802-225108.png">
   <link rel="apple-touch-icon" href="https://i.ibb.co/r28SP1bN/20250802-225108.png">
    <meta property="og:image" content="https://i.ibb.co/r28SP1bN/20250802-225108.png">
    <meta property="og:title" content="Laam wallet - Modern Digital Currency">
    <meta property="og:description" content="Laam Token is a digital asset built on Stellar with a fixed supply.">
    <meta property="og:url" content="https://laam.online">
    <meta property="og:type" content="website">
<!-- Android PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1976d2">

<!-- iPhone / iPad PWA -->
<link rel="apple-touch-icon" href="https://i.ibb.co/r28SP1bN/20250802-225108.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Laam Wallet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/10.4.0/stellar-sdk.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<!-- Add Chart.js for beautiful charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* Mobile-first responsive design */
  :root{
    /* Modern Purple & Dark Theme */
    --bg1: #0f0f23;
    --bg2: #1a1a2e;
    --card: rgba(26, 26, 46, 0.8);
    --text: #f0f0f0;
    --muted: #a0a0c0;
    --brand: #7c3aed;
    --brand2: #6d28d9;
    --line: rgba(255, 255, 255, 0.1);
    --ok: #10b981;
    --warn: #f59e0b;
    --err: #ef4444;
    --maxw: 920px;
    --rad: 20px;
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    color: var(--text);
    background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px 14px;
    position: relative;
    overflow-x: hidden;
  }
  
  body::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
      radial-gradient(circle at 10% 20%, rgba(124, 58, 237, 0.1) 0%, transparent 20%),
      radial-gradient(circle at 90% 80%, rgba(16, 185, 129, 0.1) 0%, transparent 20%),
      radial-gradient(circle at 50% 50%, rgba(245, 158, 11, 0.05) 0%, transparent 50%);
    z-index: -1;
  }
    <body>
  <h2>Laam Wallet Notifications </h2>
  <button onclick="initNotifications()">Enable Notifications</button>
  /* Receipt Modal Styles */
:root{
  --bg: #0f1724;
  --card: #0b1220;
  --glass: rgba(255,255,255,0.03);
  --muted: #9aa3b2;
  --accent: #4CAF50;
  --accent-2: #2196F3;
  --radius: 14px;
  --shadow: 0 10px 30px rgba(2,6,23,0.6);
  --glass-border: rgba(255,255,255,0.04);
  --glass-gradient: linear-gradient(135deg, rgba(72,94,255,0.06), rgba(76,175,80,0.03));
}

.receipt-modal{
  position: fixed;
  inset: 0;
  display: none;            /* toggled by JS */
  align-items: center;
  justify-content: center;
  z-index: 1200;
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}

/* backdrop */
.receipt-backdrop{
  position: absolute;
  inset: 0;
  background: white;
  backdrop-filter: blur(6px) saturate(1.05);
  -webkit-backdrop-filter: blur(6px);
  transition: opacity .18s ease;
}

/* card */
.receipt-card{
  position: relative;
  width: 96%;
  max-width: 520px;
  border-radius: var(--radius);
  background: white;
  box-shadow: var(--shadow);
  overflow: hidden;
  border: 1px solid var(--glass-border);
  transform: translateY(12px) scale(0.995);
  opacity: 0;
  transition: transform .22s cubic-bezier(.2,.9,.2,1), opacity .22s ease;
}

/* show states toggled by JS */
.receipt-modal.show{
  display: flex;
}
.receipt-modal.show .receipt-card{
  transform: translateY(0) scale(1);
  opacity: 1;
}

/* header */
.receipt-header{
  display:flex;
  align-items:center;
  gap:14px;
  padding:18px;
  border-bottom: 1px solid rgba(255,255,255,0.02);
}
.status-badge{
  width:56px;
  height:56px;
  min-width:56px;
  border-radius:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  background: var(--glass-gradient);
  box-shadow: 0 6px 18px rgba(76,175,80,0.08), inset 0 1px 0 rgba(255,255,255,0.02);
}
.header-text h2{
  margin:0;
  font-size:18px;
  letter-spacing: -0.2px;
}
.header-text .muted{
  margin:2px 0 0 0;
  color:var(--muted);
  font-size:13px;
}

/* close */
.close-btn{
  margin-left:auto;
  border: none;
  background: transparent;
  color: var(--muted);
  font-size:16px;
  cursor:pointer;
  padding:6px;
}

/* body */
.receipt-body{
  padding:18px;
}
.receipt-panel{
  background: rgba(255,255,255,0.02);
  border-radius:12px;
  padding:14px;
  border: 1px solid rgba(255,255,255,0.02);
}

/* rows */
.row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 6px;
}
.row.small{ padding-top:6px; padding-bottom:6px; font-size:14px; color:var(--muted); }
.label{ color: black; font-weight:600; font-size:13px; }
.value{ font-weight:700; font-size:15px; color: black; }
.value.highlight{ color: var(--accent); }
.value.success{ color: var(--accent); font-weight:700; }

/* divider */
.divider{
  height:1px;
  background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,0.03), rgba(255,255,255,0));
  margin:8px 0 12px;
}

/* meta */
.meta{ font-size:13px; color:var(--muted); display:flex; flex-direction:column; gap:8px; }
.meta-row{ display:flex; align-items:center; gap:10px; justify-content:space-between; }
.meta-label{ opacity:0.9; }
.meta-value{ font-family: monospace; max-width:65%; overflow:hidden; text-overflow: ellipsis; white-space: nowrap; color:#dbeafe; }
.meta-copy{ border: none; background: white; color:var(--accent-2); cursor:pointer; padding:6px; font-weight:600; }

/* actions */
.actions{ display:flex; gap:10px; margin-top:14px; }
.btn{ flex:1; padding:12px 14px; border-radius:10px; font-weight:700; cursor:pointer; border: 1px solid rgba(255,255,255,0.04); }
.btn.primary{ background: linear-gradient(90deg,var(--accent), #3db26f); color: white; box-shadow: 0 6px 18px rgba(76,175,80,0.12); }
.btn.outline{ background: white; color: black; border: 1px solid rgba(255,255,255,0.04); }

/* footer */
.receipt-footer{ padding:12px 18px; border-top: 1px solid rgba(255,255,255,0.02); text-align:center; }

/* checkmark animation */
.checkmark { overflow: visible; }
.check { stroke: var(--accent); stroke-dasharray: 60; stroke-dashoffset: 60; animation: draw 0.48s ease forwards .18s; }
@keyframes draw { to { stroke-dashoffset: 0; } }

/* responsive */
@media (max-width:420px){
  .receipt-card{ max-width: 92%; }
  .status-badge{ width:48px; height:48px; min-width:48px; }
  .header-text h2{ font-size:16px; }
}
  .app {
    width: 100%;
    max-width: 450px;
    text-align: center;
    position: relative;
    z-index: 1;
  }
  
  /* Logo and Header Styles */
  .logo-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin-bottom: 40px;
    position: relative;
  }
  
  .logo-container::after {
    content: "";
    position: absolute;
    bottom: -15px;
    left: 50%;
    transform: translateX(-50%);
    width: 100px;
    height: 3px;
    background: linear-gradient(90deg, transparent, var(--brand), transparent);
    border-radius: 3px;
  }
  
  .logo-container img {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    box-shadow: 0 8px 25px rgba(124, 58, 237, 0.3);
    transition: transform 0.3s ease;
  }
  
  .logo-container img:hover {
    transform: scale(1.05);
  }
  
  h1 {
    margin: 0;
    font-size: 3rem;
    font-weight: 800;
    background: linear-gradient(135deg, #7c3aed, #10b981);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 2px 10px rgba(124, 58, 237, 0.3);
  }
  
  /* Import Card Styles */
  .import-card {
    background: rgba(26, 26, 46, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--rad);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
    padding: 30px 20px;
    margin: 0 auto;
    max-width: 100%;
    position: relative;
    overflow: hidden;
  }
  
  .import-card::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--brand), var(--ok));
  }
  
  .form-group {
    margin-bottom: 20px;
    text-align: left;
  }
  
  .form-label {
    display: block;
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 8px;
    padding-left: 5px;
  }
  
  .form-input {
    width: 100%;
    padding: 14px 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    font-size: 16px;
    background: rgba(15, 15, 35, 0.7);
    color: var(--text);
    outline: none;
    transition: all 0.3s ease;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
  }
  
  .form-input:focus {
    border-color: var(--brand);
    background: rgba(15, 15, 35, 0.9);
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
  }
  
  .form-input::placeholder {
    color: var(--muted);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }
  
  .import-button {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, var(--brand), var(--brand2));
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4);
    margin-top: 16px;
    position: relative;
    overflow: hidden;
  }
  
  .import-button::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
  }
  
  .import-button:hover::before {
    left: 100%;
  }
  
  .import-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(124, 58, 237, 0.5);
  }
  
  .divider {
    margin: 24px 0;
    text-align: center;
    position: relative;
  }
  
  .divider::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: rgba(255, 255, 255, 0.1);
  }
  
  .divider-text {
    background: var(--card);
    padding: 0 16px;
    color: var(--muted);
    font-size: 14px;
    font-weight: 500;
  }
  
  .generate-link {
    text-align: center;
  }
  
  .generate-button {
    color: var(--brand);
    text-decoration: none;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: color 0.3s ease;
    text-transform: none;
    padding: 0;
    width: auto;
    box-shadow: none;
  }
  
  .generate-button:hover {
    color: var(--brand2);
  }
  
  .note-text {
    font-size: 12px;
    color: var(--muted);
    margin-top: 8px;
    line-height: 1.4;
  }
/* Key Display Modal */
  .key-modal {
    display: none;
    position: fixed;
    inset: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }
  
  .key-modal.show {
    display: flex;
  }
  
  .key-modal-content {
    background: var(--card);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--rad);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    padding: 40px 30px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    backdrop-filter: blur(10px);
    position: relative;
  }
  
  .key-modal-content::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--brand), var(--ok));
    border-radius: var(--rad) var(--rad) 0 0;
  }
  
  .key-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
  }
  
  .key-modal-title {
    font-size: 1.8rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--brand), var(--ok));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin: 0;
  }
  
  .key-modal-close {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    font-size: 2rem;
    cursor: pointer;
    color: var(--muted);
    padding: 5px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }
  
  .key-modal-close:hover {
    color: var(--text);
    background: rgba(255, 255, 255, 0.2);
  }
  
  .key-display-group {
    margin-bottom: 30px;
  }
  
  .key-display-label {
    display: block;
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 12px;
  }
  
  .key-display-container {
    position: relative;
    display: flex;
    align-items: center;
  }
  
  .key-display-input {
    width: 100%;
    padding: 15px 60px 15px 15px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    font-size: 14px;
    background: rgba(15, 15, 35, 0.7);
    color: var(--text);
    font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    word-break: break-all;
    resize: none;
  }
  
  .copy-btn {
    position: absolute;
    right: 10px;
    background: var(--brand);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);
  }
  
  .copy-btn:hover {
    background: var(--brand2);
    box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
    transform: translateY(-1px);
  }
  
  .copy-btn.copied {
    background: var(--ok);
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
  }
  
  .warning-text {
    background: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.3);
    border-radius: 12px;
    padding: 15px;
    margin: 20px 0;
    color: var(--warn);
    font-size: 14px;
    line-height: 1.5;
  }
  
  .use-account-btn {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, var(--ok), #059669);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 700;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
    position: relative;
    overflow: hidden;
  }
  
  .use-account-btn::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
  }
  
  .use-account-btn:hover::before {
    left: 100%;
  }
  
  .use-account-btn:hover {
    background: linear-gradient(135deg, #059669, #047857);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    transform: translateY(-2px);
  }
  /* Main Card Styles */
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:var(--rad);
    box-shadow:0 10px 30px rgba(0,0,0,0.1); padding:22px; margin:14px auto;
  }
  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
  @media (max-width:820px){ .grid-2{ grid-template-columns:1fr; } }
  label{ display:block; text-align:left; margin:8px 0 6px; font-weight:600; color:var(--brand); }
  input,select,button{
    width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:12px; font-size:1rem;
    background:#f8f9fa; color:var(--text); outline:none; transition:border-color .2s ease;
  }
  input:focus{ border-color:var(--brand); }
  button{
    background:var(--brand); color:#fff; font-weight:700; letter-spacing:.02em; border:none;
    box-shadow:0 4px 14px rgba(0,82,204,0.3); cursor:pointer; text-transform:uppercase; transition:all .2s ease;
  }
  button:hover{ background:var(--brand2); box-shadow:0 6px 18px rgba(0,65,163,0.4); transform:translateY(-2px); }
  button:disabled{ background:#b0bec5; cursor:not-allowed; box-shadow:none; transform:none; }
  .btn-secondary{ background:#6c757d; color:#fff; box-shadow:0 4px 14px rgba(0,0,0,0.1); }
  .btn-secondary:hover{ background:#5a6268; }
  .btn-danger{ background:var(--err); color:#fff; box-shadow:0 4px 14px rgba(220,53,69,0.3); }
  .btn-danger:hover{ background:#c82333; }
  .mono{
    font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
    background:#e9ecef; padding:10px 12px; border-radius:12px; overflow-wrap:anywhere; color:#343a40;
  }
  .muted{ color:var(--muted); font-size:.92rem; }
  .balances{ display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; }
  .pill{ background:#e9ecef; border:1px solid var(--line); padding:8px 14px; border-radius:999px; font-weight:600; }
  .hidden{ display:none; }
  .send-wrap{ display:none; margin-top:16px; text-align:left; border-top:1px solid var(--line); padding-top:16px; }
  .send-row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  @media (max-width:640px){ .send-row{ grid-template-columns:1fr; } }


  /* Wallet Container */
.wallet-container {
    background: rgba(0, 0, 0, 0.85);
    border-radius: 20px;
    padding: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.6);
    margin-bottom: 16px;
  }
  
.total-assets {
  background: linear-gradient(135deg, #2196f3, #21cbf3);
  color: white;
  border-radius: 16px;
  padding: 16px 20px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
  text-align: center;
  max-width: 220px;
  margin: 16px auto;
  transition: transform 0.3s, box-shadow 0.3s;
}

.total-assets:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
}

.total-label {
  font-size: 14px;
  font-weight: 500;
  opacity: 0.9;
}

.total-value {
  font-size: 28px;
  font-weight: bold;
  margin-top: 6px;
  letter-spacing: 1px;
}

.action-buttons {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-top: 16px;
}

.action-button {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 10px 6px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    min-height: 65px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.action-button::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
}

.action-button:hover::before {
    left: 100%;
}

.action-button:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
}

.action-button:active {
    transform: translateY(0);
}

.action-button.send {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.action-button.receive {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
}

.action-button.swap {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.action-button.lock {
    background: linear-gradient(135deg, #6b7280, #4b5563);
    color: white;
}

.action-icon {
    font-size: 1.2rem;
    margin-bottom: 4px;
}

.action-text {
    font-weight: 600;
    font-size: 0.8rem;
}

.assets-grid {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.asset-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #111827;
  border-radius: 12px;
  padding: 12px 14px;
  color: #fff;
  cursor: pointer;
  transition: all 0.3s ease;
}

.asset-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.4);
  background: rgba(255, 255, 255, 0.05);
}

.asset-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.asset-icon img {
  width: 32px;
  height: 32px;
  border-radius: 50%;
}

.asset-details .asset-name {
  font-weight: bold;
  font-size: 14px;
}

.asset-details .asset-price {
  font-size: 12px;
  color: #9ca3af;
}

.price-change.positive { color: #22c55e; }
.price-change.negative { color: #ef4444; }

.asset-right {
  text-align: right;
}

.asset-balance {
  font-size: 14px;
  font-weight: bold;
}

.asset-balance-sub {
  font-size: 12px;
  color: #9ca3af;
}

/* Trade Section Styles */
.trade-card {
  padding: 0;
  overflow: hidden;
  position: relative;
}

.trade-card::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--brand), var(--ok));
  border-radius: var(--rad) var(--rad) 0 0;
}

.trade-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 16px;
  border-bottom: 1px solid var(--line);
  width: 100%;
}

.trade-header h3 {
  margin: 0;
  font-size: 1.2rem;
}

.trade-asset-selector{ 
  display:flex; 
  align-items:center; 
  justify-content:space-between; 
  padding:14px 16px; 
  background: black; 
}

.asset-box{ 
  display:flex; 
  align-items:center; 
  gap:8px; 
}

.asset-box img{ 
  width:24px; 
  height:24px; 
  border-radius:50%; 
}

.asset-box .asset-name{ 
  font-weight:600; 
}

.asset-box .asset-issuer{ 
  font-size:.8rem; 
  color:var(--muted); 
}

.swap-icon{ 
  font-size:1.5rem; 
  background: black; 
  border-radius:50%; 
  padding:5px; 
  border:1px solid var(--line); 
  cursor:pointer; 
  transition:all 0.3s ease; 
}

.swap-icon:hover{ 
  background:var(--brand); 
  color: black; 
  transform:rotate(180deg); 
}

.trade-tabs{ 
  display:flex; 
  border-bottom:1px solid var(--line); 
  background: black; 
}

.trade-tabs .tab{ 
  flex:1; 
  padding:10px; 
  text-align:center; 
  cursor:pointer; 
  font-weight:600; 
  color:var(--muted); 
  border-bottom:3px solid transparent; 
  transition:all 0.3s ease; 
  position:relative;
  font-size: 0.9rem;
}

.trade-tabs .tab:hover{ 
  background:rgba(0,82,204,0.1); 
  color:var(--brand); 
}

.trade-tabs .tab.active{ 
  color:var(--brand); 
  border-bottom-color:var(--brand); 
  background: black; 
}

.tab-content{ 
  display:none; 
}

.tab-content.active{ 
  display:block; 
}

.overview-content{ 
  padding:16px; 
  text-align:center; 
}

.price-display {
  font-size: 2rem;
  font-weight: bold;
  margin-bottom: 8px;
  color: white;
}

.price-change {
  font-size: 0.9rem;
  margin-bottom: 16px;
  color: black;
}

.price-change.positive {
  color: white;
}

.price-change.negative {
  color: white;
}

.chart-timeframes {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.timeframe-btn { 
  padding: 6px 12px;
  border-radius: 8px;
  border: 1px solid var(--line);
  background: white;
  color: black;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.85rem;
  font-weight: 600;
}

.timeframe-btn:hover,
.timeframe-btn.active {
  background: var(--brand);
  color: black;
  border-color: var(--brand);
}

.chart-container {
  width: 100%; 
  height: 180px; 
  margin-bottom: 16px;
  position: relative;
}

.market-stats{ 
  display:grid; 
  grid-template-columns:1fr 1fr; 
  gap:12px; 
  text-align:left; 
}

.stat-item{ 
  background: black; 
  padding:10px; 
  border-radius:8px; 
  border:1px solid var(--line); 
}

.stat-label{ 
  font-size:0.8rem; 
  color:var(--muted); 
  margin-bottom:4px; 
}

.stat-value{ 
  font-weight:600; 
  color:var(--text); 
  font-size: 0.9rem;
}

.orderbook-content{ 
  padding:8px 16px 16px; 
  overflow-x: auto;
}

.orderbook-table{ 
  width:100%; 
  border-collapse:collapse; 
  margin-bottom:10px; 
  min-width: 300px;
}

.orderbook-table th,.orderbook-table td{ 
  text-align:right; 
  padding:6px 4px; 
  font-size:.85rem; 
}

.orderbook-table th{ 
  color:var(--muted); 
  font-weight:600; 
  border-bottom:2px solid var(--line); 
}

.orderbook-table th:first-child,.orderbook-table td:first-child{ 
  text-align:left; 
}

.orderbook-table .bid-row{ 
  cursor:pointer; 
  transition:background 0.2s ease; 
}

.orderbook-table .bid-row:hover{ 
  background:rgba(40,167,69,0.1); 
}

.orderbook-table .bid-row td:nth-child(2){ 
  color:var(--ok); 
  font-weight:600; 
}

.orderbook-table .ask-row{ 
  cursor:pointer; 
  transition:background 0.2s ease; 
}

.orderbook-table .ask-row:hover{ 
  background:rgba(220,53,69,0.1); 
}

.orderbook-table .ask-row td:nth-child(2){ 
  color:var(--err); 
  font-weight:600; 
}

.spread{ 
  padding:10px 0; 
  text-align:center; 
  font-weight:bold; 
  border-top:1px solid var(--line); 
  border-bottom:1px solid var(--line); 
  margin:6px 0; 
  background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%); 
  border-radius:8px;
}

.trades-content{ 
  padding:8px 16px 16px; 
  overflow-x: auto;
}

.trades-table{ 
  width:100%; 
  border-collapse:collapse; 
  min-width: 300px;
}

.trades-table th,.trades-table td{ 
  text-align:right; 
  padding:6px 4px; 
  font-size:.85rem; 
}

.trades-table th{ 
  color:var(--muted); 
  font-weight:600; 
  border-bottom:2px solid var(--line); 
}

.trades-table th:first-child,.trades-table td:first-child{ 
  text-align:left; 
}

.trade-buy{ 
  color:var(--ok); 
}

.trade-sell{ 
  color:var(--err); 
}

.trade-time{ 
  color:var(--muted); 
  font-size:0.8rem; 
}

.trade-actions{ 
  display:flex; 
  gap:12px; 
  padding:16px; 
  background:#f8f9fa; 
  border-top:1px solid var(--line); 
}

.trade-actions button{ 
  flex:1; 
  padding:14px; 
  font-size:1rem; 
  border-radius:12px; 
  text-transform:uppercase; 
  font-weight:700; 
  transition:all 0.3s ease; 
  position:relative; 
  overflow:hidden;
}

.trade-actions button:before{
  content:''; 
  position:absolute; 
  top:0; 
  left:-100%; 
  width:100%; 
  height:100%;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition:left 0.5s; 
  z-index:1;
}

.trade-actions button:hover:before{ 
  left:100%; 
}

.btn-buy{ 
  background:var(--ok); 
  box-shadow:0 4px 14px rgba(40,167,69,0.3); 
}

.btn-buy:hover{ 
  background:#218838; 
  box-shadow:0 6px 20px rgba(40,167,69,0.4); 
  transform:translateY(-2px); 
}

.btn-sell{ 
  background:var(--err); 
  color:#fff; 
  box-shadow:0 4px 14px rgba(220,53,69,0.3); 
}

.btn-sell:hover{ 
  background:#c82333; 
  box-shadow:0 6px 20px rgba(220,53,69,0.4); 
  transform:translateY(-2px); 
}

.loading-spinner{ 
  display:inline-block; 
  width:20px; 
  height:20px; 
  border:3px solid #f3f3f3; 
  border-top:3px solid var(--brand); 
  border-radius:50%; 
  animation:spin 1s linear infinite; 
}

@keyframes spin{ 
  0%{ 
    transform:rotate(0deg); 
  } 
  100%{ 
    transform:rotate(360deg); 
  } 
}

/* Modal Styles */
.trade-modal{ 
  display:none; 
  position:fixed; 
  inset:0; 
  width:100%; 
  height:100%; 
  background:rgba(0,0,0,0.5); 
  z-index:1000; 
  align-items:center; 
  justify-content:center; 
  padding: 16px;
  box-sizing: border-box;
}

.trade-modal.show{ 
  display:flex; 
}

.modal-content{ 
  background:var(--card); 
  border:1px solid var(--line); 
  border-radius:var(--rad); 
  box-shadow:0 20px 40px rgba(0,0,0,0.15); 
  padding:16px; 
  max-width:420px; 
  width:100%; 
  max-height:90vh; 
  overflow-y:auto; 
  animation:modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn{ 
  from{ 
    opacity:0; 
    transform:translateY(-50px); 
  } 
  to{ 
    opacity:1; 
    transform:translateY(0); 
  } 
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
}

.modal-header h2 {
  flex: 1;
  text-align: center;
  margin: 0;
  font-size: 18px;
  font-weight: bold;
  color: #6a0dad;
}

.modal-header .close-btn {
  background: transparent;
  border: none;
  font-size: 20px;
  cursor: pointer;
  color: #999;
}

.panel{ 
  background:#f8f9fa; 
  border:1px solid var(--line); 
  border-radius:12px; 
  padding:16px; 
  margin:0; 
}

.titleRow{ 
  display:flex; 
  justify-content:space-between; 
  align-items:center; 
  margin-bottom:16px; 
}

.title{ 
  font-size:1.1rem; 
  font-weight:700; 
  color:var(--brand); 
}

.avail{ 
  font-size:.85rem; 
  color:var(--muted); 
}

.field{ 
  margin-bottom:14px; 
}

.inputWrap{ 
  position:relative; 
  display:flex; 
  align-items:center; 
}

.inputWrap input{ 
  padding-right:60px; 
  margin:0; 
  border:2px solid var(--line); 
  transition:border-color 0.3s ease; 
}

.inputWrap input:focus{ 
  border-color:var(--brand); 
  box-shadow:0 0 0 3px rgba(0,82,204,0.1); 
}

.unit{ 
  position:absolute; 
  right:12px; 
  color:var(--muted); 
  font-weight:600; 
  pointer-events:none; 
}

.hint{ 
  font-size:.8rem; 
  color:var(--muted); 
  margin-top:4px; 
  text-align:left; 
}

.rowBtns{ 
  display:flex; 
  gap:6px; 
  margin-top:6px; 
}

.rowBtns button{ 
  flex:1; 
  padding:6px 10px; 
  font-size:.7rem; 
  background: Green; 
  color:var(--text); 
  border:1px solid var(--line); 
  text-transform:none; 
  font-weight:600; 
  border-radius:6px;
  transition:all 0.3s ease;
}

.rowBtns button:hover{ 
  background:var(--brand); 
  color: black; 
  transform:translateY(-1px); 
}

.totalBox{ 
  margin-bottom:16px; 
}

.totalBox input{ 
  background: black; 
  color:var(--muted); 
}

.cta{ 
  padding:14px; 
  font-size:1rem; 
  font-weight:700; 
  text-transform:uppercase; 
  margin:0; 
  border-radius:12px; 
  transition:all 0.3s ease; 
  position:relative; 
  overflow:hidden;
}

.cta:before{
  content:''; 
  position:absolute; 
  top:0; 
  left:-100%; 
  width:100%; 
  height:100%;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition:left 0.5s; 
  z-index:1;
}

.cta:hover:before{ 
  left:100%; 
}

.cta.buy{ 
  background:var(--ok); 
  box-shadow:0 4px 14px rgba(40,167,69,0.3); 
}

.cta.buy:hover{ 
  background:#218838; 
  box-shadow:0 6px 20px rgba(40,167,69,0.4); 
  transform:translateY(-2px); 
}

.cta.sell{ 
  background:var(--err); 
  color: black; 
  box-shadow:0 4px 14px rgba(220,53,69,0.3); 
}

.cta.sell:hover{ 
  background:#c82333; 
  box-shadow:0 6px 20px rgba(220,53,69,0.4); 
  transform:translateY(-2px); 
}

/* Fix for Buy/Sell Laam buttons and input text visibility */
.btn-buy { 
  background: linear-gradient(135deg, #10b981, #059669) !important; 
  color: white !important;
  box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3) !important;
  border: none !important;
}

.btn-buy:hover { 
  background: linear-gradient(135deg, #059669, #047857) !important;
  box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4) !important; 
  transform: translateY(-2px) !important;
}

.btn-sell { 
  background: linear-gradient(135deg, #ef4444, #dc2626) !important; 
  color: white !important;
  box-shadow: 0 4px 14px rgba(239, 68, 68, 0.3) !important;
  border: none !important;
}

.btn-sell:hover { 
  background: linear-gradient(135deg, #dc2626, #b91c1c) !important;
  box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4) !important; 
  transform: translateY(-2px) !important;
}
/* Swap Modal Styles */
#swapModal .panel {
  background: #f8f9fa;
  border-radius: 16px;
  padding: 20px;
}

#swapModal .field {
  margin-bottom: 20px;
}

#swapModal .inputWrap {
  position: relative;
  display: flex;
  align-items: center;
}

#swapModal .inputWrap input {
  width: 100%;
  padding: 12px 70px 12px 15px;
  border: 2px solid #e0e0e0;
  border-radius: 12px;
  font-size: 16px;
  background: white;
  color: #333;
  outline: none;
  transition: border-color 0.3s ease;
}

#swapModal .inputWrap input:focus {
  border-color: #1976d2;
  box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
}

#swapModal .unit {
  position: absolute;
  right: 12px;
  color: #666;
  font-weight: 600;
  background: #e9ecef;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 14px;
}

#swapModal .rowBtns {
  display: flex;
  gap: 8px;
  margin: 8px 0;
}

#swapModal .rowBtns button {
  flex: 1;
  padding: 8px 12px;
  font-size: 12px;
  background: #e9ecef;
  color: #333;
  border: 1px solid #ddd;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
}

#swapModal .rowBtns button:hover {
  background: #1976d2;
  color: white;
  border-color: #1976d2;
}

#swapModal .avail {
  font-size: 12px;
  color: #666;
  margin-top: 4px;
}

#swapModal select {
  width: 100%;
  padding: 10px 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  background: white;
  color: #333;
  outline: none;
}

#swapModal .cta {
  width: 100%;
  padding: 15px;
  background: #1976d2;
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s ease;
}

#swapModal .cta:hover {
  background: #1565c0;
}
/* Fix input text visibility in trade modal */
.trade-modal input {
  background: white !important;
  color: #333 !important;
  border: 1px solid #ddd !important;
}

.trade-modal input:focus {
  border-color: var(--brand) !important;
  box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2) !important;
}

.trade-modal .unit {
  color: var(--muted);
  font-weight: 600;
}

.trade-modal .totalBox input {
  background: #f8f9fa !important;
  color: #333 !important;
  border: 1px solid #ddd !important;
}

.trade-modal .hint {
  color: #666 !important;
}

.trade-modal .avail {
  color: #666 !important;
}

/* Trade actions buttons (hoosta laam buy/sell) */
.trade-actions .btn-buy {
  background: linear-gradient(135deg, #10b981, #059669) !important;
  color: #fff !important;
}

.trade-actions .btn-sell {
  background: linear-gradient(135deg, #ef4444, #dc2626) !important;
  color: #fff !important;
}

/* Token Modal Styles */
.token-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(5px);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  padding: 16px;
  box-sizing: border-box;
}

.token-modal.show {
  display: flex;
}

.token-modal-content {
  background: linear-gradient(135deg, #1a1a2e, #16213e);
  width: 100%;
  max-width: 280px;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
  animation: modalAppear 0.3s ease-out;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

@keyframes modalAppear {
  from { transform: translateY(50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.token-modal-header {
  padding: 20px 20px 10px 20px;
  text-align: center;
  background: rgba(0, 0, 0, 0.2);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.token-modal-header h2 {
  font-size: 18px;
  margin-bottom: 4px;
  color: white;
  font-weight: 700;
}

.token-modal-header p {
  font-size: 12px;
  color: #a0a0c0;
}

.token-modal-body {
  padding: 15px 20px 20px 20px;
}

.token-info {
  display: flex;
  align-items: center;
  margin-bottom: 20px;
  padding: 15px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 15px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.token-icon {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  background: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.token-icon img {
  width: 70%;
  height: 70%;
  object-fit: contain;
  border-radius: 50%;
}

.token-details h3 {
  font-size: 16px;
  margin-bottom: 4px;
  color: white;
  font-weight: 700;
}

.token-details p {
  color: #a0a0c0;
  font-size: 12px;
}

/* Small Beautiful Buttons */
.token-modal-actions {
  display: flex;
  gap: 8px;
  justify-content: space-between;
}

.token-modal-btn {
  flex: 1;
  padding: 12px 8px;
  border-radius: 12px;
  border: none;
  font-weight: 600;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: white;
  min-height: 55px;
  position: relative;
  overflow: hidden;
}

.token-modal-btn::before {
  content: "";
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
  transition: left 0.5s;
}

.token-modal-btn:hover::before {
  left: 100%;
}

.token-modal-btn i {
  font-size: 16px;
  margin-bottom: 5px;
}

.token-modal-btn.send {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

.token-modal-btn.send:hover {
  background: linear-gradient(135deg, #dc2626, #b91c1c);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
}

.token-modal-btn.receive {
  background: linear-gradient(135deg, #10b981, #059669);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.token-modal-btn.receive:hover {
  background: linear-gradient(135deg, #059669, #047857);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
}

.token-modal-btn.trustline {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

.token-modal-btn.trustline:hover {
  background: linear-gradient(135deg, #d97706, #b45309);
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
}

.token-modal-btn:active {
  transform: scale(0.95);
}

.close-token-modal {
  position: absolute;
  top: 12px;
  right: 12px;
  background: rgba(255, 255, 255, 0.1);
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.close-token-modal:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: rotate(90deg);
}

.close-token-modal i {
  font-size: 16px;
  color: white;
}

/* Hide trustline button for XLM */
.token-modal-btn.trustline.hidden {
  display: none;
}

/* When trustline is hidden, make other buttons wider */
.token-modal-btn:only-child,
.token-modal-btn:nth-child(2):nth-last-child(2) {
  flex: 1;
}

.token-modal-btn:nth-child(2):nth-last-child(1) {
  flex: 1;
}

/* Toast Container */
#toastContainer {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10000;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

.custom-alert {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #28a745;
  color: black;
  padding: 14px 22px;
  border-radius: 12px;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  z-index: 9999;
  display: none;
  animation: fadeInUp 0.4s ease;
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translate(-50%, 20px); }
  to { opacity: 1; transform: translate(-50%, 0); }
}
.trade-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: white;
  border-radius: 12px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  animation: modalFadeIn 0.3s ease-out;
}

.modal-header {
  padding: 20px 20px 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.panel {
  padding: 0 20px 20px;
}

.close-btn {
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
  color: #666;
}

@keyframes modalFadeIn {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
/* My Orders Modal Styles */
  .my-orders-modal {
    display: none;
    position: fixed;
    inset: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }
  
  .my-orders-modal.show {
    display: flex;
  }
  
  .my-orders-modal-content {
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: var(--rad);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    padding: 30px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
  }
  
  .my-orders-modal-content::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--brand), var(--ok));
    border-radius: var(--rad) var(--rad) 0 0;
  }
  
  .my-orders-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
  }
  
  .my-orders-modal-title {
    font-size: 1.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--brand), var(--ok));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin: 0;
  }
  
  .my-orders-modal-close {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    font-size: 1.8rem;
    cursor: pointer;
    color: var(--muted);
    padding: 5px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }
  
  .my-orders-modal-close:hover {
    color: var(--text);
    background: rgba(255, 255, 255, 0.2);
  }
  
  .orders-list {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 20px;
  }
  
  .order-item {
    display: flex;
    justify-content: space-between;
    padding: 12px;
    border: 1px solid var(--line);
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    background: rgba(15, 15, 35, 0.7);
  }
  
  .order-item:hover {
    background-color: rgba(124, 58, 237, 0.1);
  }
  
  .order-item.selected {
    border-color: var(--brand);
    background-color: rgba(124, 58, 237, 0.2);
  }
  
  .order-type {
    font-weight: 700;
    text-transform: uppercase;
    font-size: 12px;
  }
  
  .order-type.buy {
    color: var(--ok);
  }
  
  .order-type.sell {
    color: var(--err);
  }
  
  .order-amount, .order-price {
    font-family: 'SF Mono', monospace;
  }
  
  .order-actions {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  
  .order-action-btn {
    width: 100%;
    padding: 15px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: none;
    position: relative;
    overflow: hidden;
  }
  
  .order-action-btn::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
  }
  
  .order-action-btn:hover::before {
    left: 100%;
  }
  
  .edit-order-btn {
    background: var(--brand);
    color: white;
    box-shadow: 0 4px 16px rgba(124, 58, 237, 0.3);
  }
  
  .edit-order-btn:hover {
    background: var(--brand2);
    box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4);
    transform: translateY(-2px);
  }
  
  .cancel-order-btn {
    background: var(--err);
    color: white;
    box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
  }
  
  .cancel-order-btn:hover {
    background: #dc2626;
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    transform: translateY(-2px);
  }
/* Fix for Edit Order Modal Inputs */
#editOrderModal input {
    background: white !important;
    color: #333 !important;
    border: 1px solid #ddd !important;
}

#editOrderModal input:focus {
    border-color: var(--brand) !important;
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2) !important;
}

#editOrderModal .panel {
    background: #f8f9fa !important;
}

#editOrderModal label {
    color: #333 !important;
}
     #wizardOverlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  z-index: 999;
}

/* Modal wrap */
#sendWizard {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: black;
  padding: 20px;
  border-radius: 12px;
  z-index: 1000;
  width: 320px;
  max-width: 90%;
  color: white;
  box-sizing: border-box;
}


/* Steps */
#sendWizard h3 {
  margin-bottom: 15px;
  font-size: 20px;
  font-weight: 600;
}

#sendWizard input, 
#sendWizard select {
  width: 100%;
  padding: 10px 12px;
  margin: 10px 0;
  border-radius: 10px;
  border: none;
  outline: none;
  background: rgba(255,255,255,0.1);
  color: #fff;
}
#confirmDest {
  display: inline-block;
  word-break: break-all;   /* jebin xaraf kasta haddii uu dhaafo */
  overflow-wrap: anywhere; /* taageero dheeraad ah */
  max-width: 100%;         /* ha ka bixin box-kiisa */
}
/* Button group */
.btn-group {
  display: flex;
  justify-content: space-between;
  gap: 10px;
  margin-top: 15px;
}

.wizard-btn {
  flex: 1;
  padding: 10px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
}

.wizard-btn.primary {
  background: #007aff;
  color: #fff;
}
.wizard-btn.primary:hover {
  background: #005fcc;
}

.wizard-btn.secondary {
  background: rgba(255,255,255,0.15);
  color: #fff;
}
.wizard-btn.secondary:hover {
  background: rgba(255,255,255,0.25);
}

.wizard-btn.confirm {
  background: #4cd964;
  color: #fff;
}
.wizard-btn.confirm:hover {
  background: #38b64c;
}

/* Responsive Design */
@media (max-width: 480px) {
  #sendWizard {
    width: 90%;
    padding: 22px 18px;
  }

  #sendWizard h2 {
    font-size: 1.3rem;
  }

  .wizard-btn {
    padding: 10px;
    font-size: 14px;
  }
}

.assets-grid {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.asset-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #111827;
  border-radius: 12px;
  padding: 12px 16px;
  color: #fff;
}

.asset-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.asset-icon img {
  width: 32px;
  height: 32px;
  border-radius: 50%;
}

.asset-details .asset-name {
  font-weight: bold;
  font-size: 14px;
}

.asset-details .asset-price {
  font-size: 12px;
  color: #9ca3af;
}

.price-change.positive { color: #22c55e; }
.price-change.negative { color: #ef4444; }

.asset-right {
  text-align: right;
}

.asset-balance {
  font-size: 14px;
  font-weight: bold;
}

.asset-balance-sub {
  font-size: 12px;
  color: #9ca3af;
}
     
/* Make asset items clickable */
.clickable-asset {
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
}

.clickable-asset:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.4);
  background: rgba(255, 255, 255, 0.05);
}

.clickable-asset:active {
  transform: translateY(0);
}

/* Trustline button in token modal */
.token-modal-btn.trustline {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: white;
}

.token-modal-btn.trustline:hover {
  background: linear-gradient(135deg, #d97706, #b45309);
  transform: translateY(-2px);
}

/* Hide trustline button for XLM */
.token-modal-btn.trustline.hidden {
  display: none;
}  
  
  .app {
    max-width: 450px;
  }
  
  .logo-container {
    margin-bottom: 40px;
  }
  
  .logo-container img {
    width: 80px;
    height: 80px;
  }
  
  h1 {
    font-size: 3rem;
  }
  
  .import-card {
    padding: 40px 30px;
  }
  
  .wallet-container {
    padding: 20px;
  }
  
  .total-assets {
    padding: 20px 30px;
    max-width: 250px;
  }
  
  .total-value {
    font-size: 36px;
  }
  
  .action-buttons {
    gap: 10px;
  }
  
  .action-button {
    padding: 12px 8px;
    min-height: 70px;
  }
  
  .action-icon {
    font-size: 1.4rem;
    margin-bottom: 6px;
  }
  
  .action-text {
    font-size: 0.85rem;
  }
  
  .trade-header {
    padding: 16px 20px;
  }
  
  .trade-tabs .tab {
    padding: 12px;
  }
  
  .price-display {
    font-size: 2.5rem;
  }
  
  .chart-container {
    height: 200px;
  }
}

  
  .import-card {
    padding: 20px 16px;
  }
  
  .wallet-container {
    padding: 12px;
  }
  
  .total-assets {
    padding: 12px 16px;
    max-width: 200px;
  }
  
  .total-value {
    font-size: 24px;
  }
  

.action-buttons {
    padding: 15px;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

.action-button {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 12px 8px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    min-height: 70px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.action-button::before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
}

.action-button:hover::before {
    left: 100%;
}

.action-button:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
}

.action-button:active {
    transform: translateY(0);
}

.action-button.send {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.action-button.receive {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
}

.action-button.swap {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.action-button.lock {
    background: linear-gradient(135deg, #6b7280, #4b5563);
    color: white;
}

.action-icon {
    font-size: 1.4rem;
    margin-bottom: 6px;
}

.action-text {
    font-weight: 600;
    font-size: 0.85rem;
}

/* Responsive design */
@media (max-width: 480px) {
    .action-buttons {
        padding: 12px;
        gap: 8px;
    }
    
    .action-button {
        padding: 10px 6px;
        min-height: 65px;
    }
    
    .action-icon {
        font-size: 1.2rem;
        margin-bottom: 4px;
    }
    
    .action-text {
        font-size: 0.8rem;
    }
  
  .asset-item {
    padding: 10px 12px;
  }
  
  .asset-icon img {
    width: 28px;
    height: 28px;
  }
  
  .asset-details .asset-name {
    font-size: 13px;
  }
  
  .asset-details .asset-price {
    font-size: 11px;
  }
  
  .asset-balance {
    font-size: 13px;
  }
  
  .asset-balance-sub {
    font-size: 11px;
  }
}
</style>
</head>
<body>
  <div class="app">

<!-- AUTH SECTION -->
    <div id="authSection">
      <div class="import-card">
        <div id="unlockView" class="hidden">
          <h3 style="margin:0 0 20px 0; color:#1976d2; text-align:center; font-size:1.5rem;">Unlock Wallet</h3>
          <div class="form-group">
            <label class="form-label" for="walletPassword">Password</label>
            <input class="form-input" id="walletPassword" type="password" placeholder="Enter your password" />
          </div>
          <button class="import-button" id="unlockBtn">Unlock</button>
            
          <div class="divider">
            <span class="divider-text">or</span>
          </div>
          <div class="generate-link">
            <a href="#" id="resetWalletLink" style="color:#1976d2; text-decoration:none;">Reset and Import New Key</a>
          </div>
        </div>

        <div id="initialView">
          <div class="form-group">
            <label class="form-label" for="secretKeyInput">Secret Key (S...)</label>
            <input class="form-input" id="secretKeyInput" type="password" placeholder="SXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"/>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="savePasswordInput">Create Password to Save</label>
            <input class="form-input" id="savePasswordInput" type="password" placeholder="Min 8 chars"/>
          </div>
          
          <button class="import-button" id="importAndSaveBtn">Import wallet and Save</button>
 
          <!-- Real Fingerprint Unlock Section -->
          <div class="fingerprint-section" id="fingerprintSection" style="display: none;">
            <div class="divider">
              <span class="divider-text">or unlock with</span>
            </div>
            
            <button class="fingerprint-btn" id="fingerprintUnlockBtn">
              <span class="fingerprint-icon"></span>
              Fingerprint Unlock
            </button>
            
            <div id="fingerprintStatus" class="fingerprint-status disabled">
              Fingerprint unlock not set up
            </div>
            
            <button class="setup-fingerprint-btn" id="setupFingerprintBtn">
              Set Up Fingerprint Unlock
            </button>
            
            <div class="device-support-info">
              Supported: Touch ID, Face ID, Windows Hello, Android Biometric
            </div>
          </div>
          
          
          <div class="divider">
            <span class="divider-text">or</span>
          </div>
          
          <div class="generate-link">
            <button class="generate-button" id="generateAccountBtn">Create new wallet</button>
            <p class="note-text">(Remember: You must deposit at least 4 XLM into your wallet for it to be activated.)</p>
          </div>
        </div>
      </div>
    </div>
 

    <!-- Key Display Modal -->
    <div id="keyModal" class="key-modal">
      <div class="key-modal-content">
        <div class="key-modal-header">
          <h3 class="key-modal-title">New Wallet Account Generated</h3>
          <button class="key-modal-close" onclick="closeKeyModal()">&times;</button>
        </div>
        
        <div class="key-display-group">
          <label class="key-display-label">Secret Key (S...)</label>
          <div class="key-display-container">
            <textarea class="key-display-input" id="generatedSecretKey" readonly rows="3"></textarea>
            <button class="copy-btn" onclick="copyToClipboard('generatedSecretKey', this)">Copy</button>
          </div>
        </div>

        <div class="key-display-group">
          <label class="key-display-label">Public Key (G...)</label>
          <div class="key-display-container">
            <textarea class="key-display-input" id="generatedPublicKey" readonly rows="2"></textarea>
            <button class="copy-btn" onclick="copyToClipboard('generatedPublicKey', this)">Copy</button>
          </div>
        </div>

        <div class="warning-text">
          <strong>IMPORTANT</strong> Save your Secret Key in a secure place! You will need it to access your wallet. If you lose it, you will not be able to recover your account. Also, copy your public key and fund it with at least 4 XLM to activate your wallet.
        </div>

        <button class="use-account-btn" onclick="useGeneratedAccount()">Use This Account</button>
      </div>
    </div>

    
    <!-- LOGGED IN VIEW -->
    <div id="loggedInView" class="hidden">
      <!-- Wallet Container with New Design -->
      <div class="wallet-container">
        <!-- Total Assets -->
<div class="total-assets">
   Total Assets: $<span id="totalAssets">0.00</span>
</div>

<!-- Wizard Overlay -->
<div id="wizardOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;"></div>

<!-- Send Wizard Modal -->
<div id="sendWizard" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:black; padding:20px; border-radius:12px; z-index:1000; width:320px; max-width:90%; color:white;">
  <h3></h3>

  <!-- Error Box -->
  <div id="wizardError" style="display:none; color:#ff3b30; font-weight:600; margin-bottom:10px; text-align:center;">
    Please fill in all required fields
  </div>

  <!-- Step 1: Choose Asset -->
  <div id="step1" class="wizard-step">
    <label for="sendAsset">Asset <span style="color:red">*</span></label>
    <select id="sendAsset" style="width:100%; margin-bottom:10px;">
      <option value="">--Choose--</option>
      <option value="XLM">XLM</option>
      <option value="LAAM">LAAM</option>
      <option value="USDC">USDC</option>
    </select>
    <div class="btn-group" style="display:flex; gap:10px; margin-top:10px;">
      <button onclick="nextStep(2)" style="flex:1;">Next</button>
    </div>
  </div>

  <!-- Step 2: Enter Amount -->
  <div id="step2" class="wizard-step" style="display:none;">
    <label for="sendAmount">Amount <span style="color:red">*</span></label>
    <input type="number" id="sendAmount" placeholder="0.0" style="width:100%; margin-bottom:10px;">
    <div class="btn-group" style="display:flex; gap:10px; margin-top:10px;">
      <button onclick="nextStep(3)" style="flex:1;">Next</button>
    </div>
  </div>

  <!-- Step 3: Enter Address or Scan -->
  <div id="step3" class="wizard-step" style="display:none;">
    <label for="sendDest">Destination Address <span style="color:red">*</span></label>
    <input type="text" id="sendDest" placeholder="Enter Stellar address" style="width:100%; margin-bottom:10px;">
    <button type="button" id="scanQRBtn" style="width:100%; margin-bottom:10px;">Scan QR</button>
    <div id="qr-reader" style="width:100%; display:none; margin-bottom:10px;"></div>
    <div class="btn-group" style="display:flex; gap:10px; margin-top:10px;">
      <button onclick="nextStep(4)" style="flex:1;">Next</button>
    </div>
  </div>

  <!-- Step 4: Memo (Optional) -->
  <div id="step4" class="wizard-step" style="display:none;">
    <label for="sendMemo">Memo (Optional)</label>
    <input type="text" id="sendMemo" placeholder="Memo text" style="width:100%; margin-bottom:10px;">
    <div class="btn-group" style="display:flex; gap:10px; margin-top:10px;">
      <button onclick="nextStep(5)" style="flex:1;">Next</button>
    </div>
  </div>

  <!-- Step 5: Confirm -->
  <div id="step5" class="wizard-step" style="display:none;">
    <h4>Confirm Transaction</h4>
    <p>Asset: <span id="confirmAsset"></span></p>
    <p>Amount: <span id="confirmAmount"></span></p>
    <p>Destination: <span id="confirmDest" style="display:inline-block; word-break:break-all; max-width:100%;"></span></p>
    <p>Memo: <span id="confirmMemo"></span></p>
    <div class="btn-group" style="display:flex; gap:10px; margin-top:20px;">
      <button id="confirmSendBtn" onclick="sendTransaction()" style="flex:1;">Send Now</button>
    </div>
  </div>
<!-- Step 6: Enhanced Receipt -->
<div id="step6" class="wizard-step" style="display:none; text-align:left;">
  <div style="background:white; padding:20px; border-radius:16px; color:#111827; box-shadow:0 6px 15px rgba(0,0,0,0.15); font-family:sans-serif;">
    <div style="display:flex; flex-direction:column; align-items:center; gap:8px; margin-bottom:15px; color:#333;">
  <h4 style="margin:0; font-size:1rem;">transaction sent successfully</h4>
  <img src="https://i.postimg.cc/FHZj9xVh/images-5.png" alt="Laam image" style="width:80px; height:auto;">
</div>

    <p style="margin:8px 0; word-break:break-word;">
      <strong>Destination:</strong> <span id="receiptDest"></span>
      <button onclick="copyToClipboard('receiptDest')" title="Copy" style="margin-left:5px; padding:4px 6px; font-size:12px; border:none; border-radius:6px; background:#f0f0f0; color:#333; cursor:pointer;">
        
      </button>
    </p>

    <p style="margin:8px 0; word-break:break-all;">
      <strong>Txid / Hash:</strong> 
      <a id="receiptHash" href="#" target="_blank" style="color:#1a73e8; text-decoration:underline;"></a>
      <button onclick="copyToClipboard('receiptHash')" title="Copy" style="margin-left:5px; padding:4px 6px; font-size:12px; border:none; border-radius:6px; background:#f0f0f0; color:#333; cursor:pointer;">
        
      </button>
    </p>

    <p style="margin:8px 0;"><strong>Amount:</strong> <span id="receiptAmount"></span></p>
    <p style="margin:8px 0;"><strong>Date:</strong> <span id="receiptDate"></span></p>

    <div style="text-align:center; margin-top:20px;">
      <button onclick="closeWizard()" style="padding:10px 20px; font-size:14px; border:none; border-radius:12px; background:green; color:white; font-weight:600; cursor:pointer;">done</button>
    </div>
  </div>
</div>
 </div>
</div>

   <!-- Action Buttons -->
        <div class="action-buttons">
          <div class="action-button send" id="btnSend">
            <div class="action-icon"></div>
            <div class="action-text">Send</div>
          </div>
          <div class="action-button receive" id="btnReceive">
            <div class="action-icon"></div>
            <div class="action-text">Receive</div>
          </div>
          <div class="action-button swap" id="swapBtn">
            <div class="action-icon"></div>
            <div class="action-text">Swap</div>
          </div>
          <div class="action-button lock" id="logoutBtn">
            <div class="action-icon"></div>
            <div class="action-text">Lock</div>
          </div>
        </div>
        
        <!-- Assets Grid -->
<div class="assets-grid">
  <!-- XLM -->
  <div class="asset-item clickable-asset" data-token="XLM">
    <div class="asset-left">
      <div class="asset-icon">
        <img src="https://res.coinpaper.com/coinpaper/stellar_xlm_logo_07021d63c0.png" alt="XLM">
      </div>
      <div class="asset-details">
        <div class="asset-name">XLM</div>
        <div class="asset-price">
          <small class="per">$<span id="xlmPrice">0.409</span></small>
          <span id="xlmChange" class="price-change positive">+2.5%</span>
        </div>
      </div>
    </div>
    <div class="asset-right">
      <div class="asset-balance"><span id="xlmBal">0</span> XLM</div>
      <div class="asset-balance-sub"> $<span id="xlmBalUsd">0</span></div>
    </div>
  </div>

  <!-- LAAM -->
  <div class="asset-item clickable-asset" data-token="LAAM">
    <div class="asset-left">
      <div class="asset-icon">
        <img src="https://i.ibb.co/r28SP1bN/20250802-225108.png" alt="LAAM">
      </div>
      <div class="asset-details">
        <div class="asset-name">Laam</div>
        <div class="asset-price">
          <small class="per">$<span id="laamPrice">0.056</span></small>
          <span id="laamChange" class="price-change negative">-1.2%</span>
        </div>
      </div>
    </div>
    <div class="asset-right">
      <div class="asset-balance"><span id="laamBal">0</span> Laam</div>
      <div class="asset-balance-sub"> $<span id="laamBalUsd">0</span></div>
    </div>
  </div>

  <!-- USDC -->
  <div class="asset-item clickable-asset" data-token="USDC">
    <div class="asset-left">
      <div class="asset-icon">
        <img src="https://i.ibb.co/r2qNFs22/images-2.png" alt="USDC">
      </div>
      <div class="asset-details">
        <div class="asset-name">USDC</div>
        <div class="asset-price">
          <small class="per">$<span id="usdcPrice">1.00</span></small>
          <span id="usdcChange" class="price-change">0.00%</span>
        </div>
      </div>
    </div>
    <div class="asset-right">
      <div class="asset-balance"><span id="usdcBal">0</span> USDC</div>
      <div class="asset-balance-sub"> $<span id="usdcBalUsd">0</span></div>
    </div>
  </div>
</div>
      <!-- Updated Swap Modal -->
<div id="swapModal" class="trade-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2></h2>
      <button class="close-btn" onclick="closeSwapModal()"></button>
    </div>

    <div class="panel">
      <!-- You Sell Section -->
      <div class="field">
        <label>You sell</label>
        <div class="inputWrap">
          <input id="giveAmount" type="number" placeholder="0.0" />
          <div class="unit" id="giveAssetUnit">XLM</div>
        </div>
        <div class="rowBtns">
          <button data-fill="25">25%</button>
          <button data-fill="50">50%</button>
          <button data-fill="75">75%</button>
          <button data-fill="100">100%</button>
        </div>
        <div class="avail">Available: <span id="availGiveBalance">0 XLM</span></div>
      </div>

      <!-- Swap Direction Button -->
      <div style="text-align: center; margin: 15px 0;">
        <button id="swapDirectionBtn" style="background: #1976d2; color: white; width: 40px; height: 40px; border-radius: 50%; border: none; font-size: 20px; cursor: pointer;">
          
        </button>
      </div>

      <div class="field">
        <label>You buy</label>
        <div class="inputWrap">
          <input id="getAmount" type="number" placeholder="0.0" readonly />
          <div class="unit" id="getAssetUnit">USDC</div>
        </div>
        <div class="avail">Available: <span id="availGetBalance">0 USDC</span></div>
      </div>

      <!-- Asset Selection -->
      <div class="field" style="margin-top: 20px;">
        <label>Swap Pair</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <select id="giveAsset" style="color: black;">
            <option value="XLM">XLM</option>
            <option value="LAAM">LAAM</option>
            <option value="USDC">USDC</option>
          </select>
          <select id="getAsset" style="color: black;">
            <option value="USDC">USDC</option>
            <option value="XLM">XLM</option>
            <option value="LAAM">LAAM</option>
          </select>
        </div>
      </div>

      <!-- Info Text -->
      <div style="background: #e3f2fd; border-radius: 8px; padding: 12px; margin: 15px 0; text-align: center; font-size: 12px; color: #1976d2;">
        Swap DEX and AMM
      </div>

      <button class="cta buy" id="confirmSwapBtn" style="background: #1976d2;">Swap Now</button>
    </div>
  </div>
</div>

<!-- ===== Enhanced Receipt Modal ===== -->
<div id="receiptModal" class="receipt-modal" aria-hidden="true" role="dialog" aria-labelledby="receiptTitle" aria-modal="true">
  <div class="receipt-backdrop" onclick="closeReceiptModal()" data-backdrop></div>

  <div class="receipt-card" role="document">
    <header class="receipt-header" style="display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
      <div class="status-badge" id="receiptIcon" aria-hidden="true">
        <!-- Animated checkmark -->
        <svg viewBox="0 0 52 52" class="checkmark" width="48" height="48" fill="none" stroke="none" aria-hidden="true">
          <circle cx="26" cy="26" r="25" stroke="rgba(0,0,0,0.06)" stroke-width="2"></circle>
          <path class="check" d="M14 27l6 6 18-18" stroke="#22c55e" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"></path>
        </svg>
      </div>

      <div class="header-text" style="text-align: center;">
        <h2 id="receiptTitle" style="margin-top: 10px; font-size: 1.5rem; color: #111;">Swap Successful</h2>
      </div>
    </header>

    <main class="receipt-body">
      <div class="receipt-panel">
        <div class="row">
          <div class="label">You Sold</div>
          <div class="value" id="receiptGive"></div>
        </div>

        <div class="row">
          <div class="label">You Received</div>
          <div class="value highlight" id="receiptGet"></div>
        </div>

        <div class="row small">
          <div class="label">Exchange Rate</div>
          <div class="value" id="receiptRate"></div>
        </div>

        <div class="row small">
          <div class="label">Status</div>
          <div class="value success" style="color:#22c55e;">Successful</div>
        </div>

        <div class="divider"></div>

        <div class="meta">
          <div class="meta-row">
            <span class="meta-label">Transaction Hash</span>
            <span class="meta-value" id="receiptHash"></span>
            <button class="meta-copy" onclick="copyTx()">Copy</button>
          </div>
          <div class="meta-row">
            <span class="meta-label">Time (UTC)</span>
            <span class="meta-value" id="receiptTime"></span>
          </div>
        </div>
      </div>

      <div class="actions">
        <button class="btn outline" onclick="viewTransactionDetails()">View Details</button>
        <button class="btn primary" onclick="closeAndRefresh()">Done</button>
      </div>
    </main>
  </div>
</div>

      <!-- Token Modal -->
<div class="token-modal" id="tokenModal">
  <div class="token-modal-content">
    <div class="token-modal-header">
      <h2 id="modalTokenName">XLM</h2>
      <p>Select an action</p>
    </div>
    <div class="token-modal-body">
      <div class="token-info">
        <div class="token-icon">
          <img id="modalTokenIcon" src="https://res.coinpaper.com/coinpaper/stellar_xlm_logo_07021d63c0.png" alt="Token">
        </div>
        <div class="token-details">
          <h3 id="modalTokenBalance">0 XLM</h3>
          <p id="modalTokenValue">$0.00</p>
        </div>
      </div>
      <div class="token-modal-actions">
        <button class="token-modal-btn send" onclick="openSendWizardForToken()">
          <i></i>
          <span>Send</span>
        </button>
        <button class="token-modal-btn receive" onclick="openReceiveForToken()">
          <i></i>
          <span>Receive</span>
        </button>
        <button class="token-modal-btn trustline" id="tokenModalTrustlineBtn" onclick="addTrustlineForToken()">
          <i>+</i>
          <span>Add Trustline</span>
        </button>
      </div>
    </div>
  </div>
  <div class="close-token-modal" onclick="closeTokenModal()">
    <i></i>
  </div>
</div>
                        
      <!-- Enhanced Trade Section -->
      <div class="card trade-card">
     <div class="trade-header">
<span class="icon" id="refreshOB" onclick="fetchOrderbook()"></span>
  <h3>Trade</h3>
  <span class="icon" id="myOrdersBtn" onclick="openMyOrdersModal()">offers</span>
</div>
        <div class="trade-asset-selector">
          <div class="asset-box">
            <img src="https://i.ibb.co/r28SP1bN/20250802-225108.png" alt="Laam">
            <div>
              <div class="asset-name">Laam</div>
              <div class="asset-issuer">laam.online</div>
            </div>
          </div>
          <span class="swap-icon" id="swapAssets" onclick="swapTradeAssets()"></span>
          <div class="asset-box">
            <img src="https://res.coinpaper.com/coinpaper/stellar_xlm_logo_07021d63c0.png" alt="XLM">
            <div>
              <div class="asset-name">XLM</div>
              <div class="asset-issuer">stellar.org</div>
            </div>
          </div>
        </div>
        
        <!-- Enhanced Trade Tabs -->
        <div class="trade-tabs">
          <div class="tab" id="overviewTab">Overview</div>
          <div class="tab active" id="orderbookTab">Orderbook</div>
          <div class="tab" id="lastTradesTab">Last Trades</div>
        </div>
        
        <!-- Overview Tab Content -->
        <div id="overviewContent" class="tab-content">
          <div class="overview-content">
            <div class="price-display">
              <span id="overviewLaamPriceXLM">0.000000</span>$
            </div>
            <div class="price-change" id="priceChange">Loading price change...</div>
            
            <div class="chart-timeframes">
              <button class="timeframe-btn active" data-timeframe="1D">1D</button>
              <button class="timeframe-btn" data-timeframe="1W">1W</button>
              <button class="timeframe-btn" data-timeframe="1M">1M</button>
              <button class="timeframe-btn" data-timeframe="ALL">ALL</button>
            </div>
            
            <!-- Chart container for Chart.js -->
            <div class="chart-container">
              <canvas id="priceChart"></canvas>
            </div>
            
            <div class="market-stats">
              <div class="stat-item">
                <div class="stat-label">24h Volume</div>
                <div class="stat-value" id="volume24h">0 Laam</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">24h High</div>
                <div class="stat-value" id="high24h">0.000000 XLM</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">24h Low</div>
                <div class="stat-value" id="low24h">0.000000 XLM</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">Market Cap</div>
                <div class="stat-value" id="marketCap">0 XLM</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Orderbook Tab Content -->
        <div id="orderbookContent" class="tab-content active">
          <div class="orderbook-content">
            <table class="orderbook-table">
              <thead><tr><th>Amount </th><th>Price </th><th>Total </th></tr></thead>
              <tbody id="asksBody">
                <tr><td colspan="3" style="text-align:center; padding:20px;"><div class="loading-spinner"></div> Loading...</td></tr>
              </tbody>
            </table>
            <div class="spread" id="spreadValue">Loading spread...</div>
            <table class="orderbook-table">
              <tbody id="bidsBody">
                <tr><td colspan="3" style="text-align:center; padding:20px;"><div class="loading-spinner"></div> Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Last Trades Tab Content -->
        <div id="lastTradesContent" class="tab-content">
          <div class="trades-content">
            <table class="trades-table">
              <thead><tr><th>Time</th><th>Type</th><th>Price (XLM)</th><th>Amount (Laam)</th></tr></thead>
              <tbody id="tradesBody">
                <tr><td colspan="4" style="text-align:center; padding:20px;"><div class="loading-spinner"></div> Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="trade-actions">
          <button class="btn-buy" id="btnBuy">Buy</button>
          <button class="btn-sell" id="btnSell">Sell</button>
        </div>

    <!-- Trade Modal -->
<div id="tradeModal" class="trade-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTitle">Trade</h2>
      <button id="closeTradeModal" class="close-btn"></button>
    </div>
    <div class="panel">
      <div class="titleRow">
        <div class="title" id="panelTitle"></div>
        <div class="avail">Available: <span id="availBalance">0 </span></div>
      </div>

      <div class="field">
        <div class="inputWrap">
          <input id="modalPrice" type="number" step="0.0000001" placeholder="0" />
          <div class="unit"></div>
        </div>
        <div class="hint">Price </div>
      </div>

      <div class="field">
        <div class="inputWrap">
          <input id="modalAmount" type="number" step="0.0000001" placeholder="Amount" />
          <div class="unit"></div>
        </div>
        <div class="rowBtns">
          <button data-fill="25">25%</button>
          <button data-fill="50">50%</button>
          <button data-fill="75">75%</button>
          <button data-fill="100">100%</button>
        </div>
      </div>

      <div class="totalBox">
        <div class="inputWrap">
          <input id="modalTotal" type="number" step="0.0000001" placeholder="Total" readonly />
          <div class="unit"></div>
        </div>
        <div class="hint">Total cost</div>
      </div>

      <button class="cta buy" id="modalBuyBtn"></button>
    </div>
  </div>
</div>

    <!-- My Orders Modal -->
    <div id="myOrdersModal" class="my-orders-modal">
      <div class="my-orders-modal-content">
        <div class="my-orders-modal-header">
          <h3 class="my-orders-modal-title">My Orders</h3>
          <button class="my-orders-modal-close" onclick="closeMyOrdersModal()">&times;</button>
        </div>
        
        <div id="ordersList" class="orders-list">
          <div class="loading-spinner"></div>
        </div>
        
        <div class="order-actions">
          <button class="order-action-btn edit-order-btn" onclick="promptEditOffer()">Edit Order</button>
          <button class="order-action-btn cancel-order-btn" onclick="confirmCancelOffer()">Cancel Order</button>
        </div>
      </div>
    </div>

    <!-- Edit Order Modal -->
    <div id="editOrderModal" class="trade-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Edit Order</h3>
          <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <div class="panel">
          <div class="field">
            <label>Amount (Laam)</label>
            <input id="editAmount" type="number" step="0.0001">
          </div>
          <div class="field">
            <label>Price (XLM per Laam)</label>
            <input id="editPrice" type="number" step="0.0000001">
          </div>
          <button class="cta" id="confirmEditBtn">Update Order</button>
        </div>
      </div>
    </div>
    <div id="errorAlert" class="custom-alert" style="background:#dc3545;">Error here</div>
    <div id="successAlert" class="custom-alert">Transaction sent successfully</div>
  </div>

  <script>
    // Laam token configuration
    const LAAM_TOKEN = {
      code: "Laam",
      issuer: "GAL4ECDAXNBMJYFCWIJ32HKVIRLCNEXY664CAZYI3EINQWPLXTMEPR64",
      name: "Laam",
      description: "Laam is a limited supply token on Stellar with a maximum of 1,335,577 tokens, issued only once to preserve value.",
      image: "https://i.ibb.co/r28SP1bN/20250802-225108.png",
      maxSupply: 1335577,
      currentPrice: 0.06
    };

    // USDC token configuration
    const USDC_TOKEN = {
      code: "USDC",
      issuer: "GA5ZSEJYB37JRC5AVCIA5MOP4RHTM335X2KGX3IHOJAPP5RE34K4KZVN"
    };
    
    
    // Global variables
    let currentKeypair = null;
    let server = null;
    let USDC_ASSET = null;
    let LAAM_ASSET = null;
    let xlmPriceUSD = 0.42;
    let currentTradeMode = 'buy';
    let generatedKeypair = null;
    let currentTab = 'orderbook';
    let orderbookData = { bids: [], asks: [] };
    let tradesData = [];
    let currentOfferId = null;
    let currentOfferType = null;
    let priceChart = null; // Chart.js instance
    let currentTradePair = 'LAAM_XLM'; // Default pair
    let currentBaseAsset = LAAM_ASSET;
    let currentCounterAsset = StellarSdk.Asset.native();
    let selectedToken = null;

// ===== Asset Helper =====
function getAssetByCode(code) {
  if (code === "XLM") return StellarSdk.Asset.native();
  if (code === "LAAM") return LAAM_ASSET;
  if (code === "USDC") return USDC_ASSET;
}

// ===== Modal Functions =====
function openSwapModal() {
  document.getElementById("swapModal").classList.add("show");
  updateSwapBalances();
  calculateSwap(); // Calculate immediately when opening
}

function closeSwapModal() {
  document.getElementById("swapModal").classList.remove("show");
}

// ===== Update Swap Balances =====
function updateSwapBalances() {
  const giveAsset = document.getElementById("giveAsset").value;
  const getAsset = document.getElementById("getAsset").value;
  
  // Update give asset balance
  const giveBalanceEl = document.getElementById(giveAsset.toLowerCase() + 'Bal');
  if (giveBalanceEl) {
    document.getElementById("availGiveBalance").textContent = giveBalanceEl.textContent + ' ' + giveAsset;
  }
  
  // Update get asset balance  
  const getBalanceEl = document.getElementById(getAsset.toLowerCase() + 'Bal');
  if (getBalanceEl) {
    document.getElementById("availGetBalance").textContent = getBalanceEl.textContent + ' ' + getAsset;
  }
}

// ===== Swap Assets Direction =====
function swapAssetsDirection() {
  const giveAsset = document.getElementById("giveAsset").value;
  const getAsset = document.getElementById("getAsset").value;
  
  // Swap the assets
  document.getElementById("giveAsset").value = getAsset;
  document.getElementById("getAsset").value = giveAsset;
  
  // Update display
  updateAssetUnits();
  updateSwapBalances();
  
  // Recalculate swap with current amount
  const currentAmount = document.getElementById("giveAmount").value;
  if (currentAmount && parseFloat(currentAmount) > 0) {
    calculateSwap();
  }
}

// ===== Update Asset Units =====
function updateAssetUnits() {
  const giveAsset = document.getElementById("giveAsset").value;
  const getAsset = document.getElementById("getAsset").value;
  
  document.getElementById("giveAssetUnit").textContent = giveAsset;
  document.getElementById("getAssetUnit").textContent = getAsset;
}

// ===== Calculate Swap Amount =====
async function calculateSwap() {
  const giveAmount = parseFloat(document.getElementById("giveAmount").value) || 0;
  const giveAsset = document.getElementById("giveAsset").value;
  const getAsset = document.getElementById("getAsset").value;
  
  if (giveAmount <= 0) {
    document.getElementById("getAmount").value = "";
    return;
  }
  
  try {
    const exchangeRate = await getExchangeRate(giveAsset, getAsset);
    const getAmount = giveAmount * exchangeRate;
    
    document.getElementById("getAmount").value = getAmount.toFixed(7);
  } catch (error) {
    console.error('Error calculating swap:', error);
    // Fallback to simple calculation
    const fallbackRate = getFallbackRate(giveAsset, getAsset);
    const getAmount = giveAmount * fallbackRate;
    document.getElementById("getAmount").value = getAmount.toFixed(7);
  }
}

// ===== Get Exchange Rate from Stellar DEX =====
async function getExchangeRate(giveAsset, getAsset) {
  if (giveAsset === getAsset) return 1;
  
  try {
    let url;
    
    // Build the Horizon API URL based on asset pair
    if (giveAsset === 'XLM' && getAsset === 'USDC') {
      url = `https://horizon.stellar.org/order_book?selling_asset_type=native&buying_asset_type=credit_alphanum4&buying_asset_code=USDC&buying_asset_issuer=${USDC_TOKEN.issuer}&limit=1`;
    } else if (giveAsset === 'USDC' && getAsset === 'XLM') {
      url = `https://horizon.stellar.org/order_book?selling_asset_type=credit_alphanum4&selling_asset_code=USDC&selling_asset_issuer=${USDC_TOKEN.issuer}&buying_asset_type=native&limit=1`;
    } else if (giveAsset === 'XLM' && getAsset === 'LAAM') {
      url = `https://horizon.stellar.org/order_book?selling_asset_type=native&buying_asset_type=credit_alphanum4&buying_asset_code=LAAM&buying_asset_issuer=${LAAM_TOKEN.issuer}&limit=1`;
    } else if (giveAsset === 'LAAM' && getAsset === 'XLM') {
      url = `https://horizon.stellar.org/order_book?selling_asset_type=credit_alphanum4&selling_asset_code=LAAM&selling_asset_issuer=${LAAM_TOKEN.issuer}&buying_asset_type=native&limit=1`;
    } else if (giveAsset === 'USDC' && getAsset === 'LAAM') {
      // For USDC to LAAM, we need to get rate through XLM
      const usdcToXlm = await getExchangeRate('USDC', 'XLM');
      const xlmToLaam = await getExchangeRate('XLM', 'LAAM');
      return usdcToXlm * xlmToLaam;
    } else if (giveAsset === 'LAAM' && getAsset === 'USDC') {
      // For LAAM to USDC, we need to get rate through XLM
      const laamToXlm = await getExchangeRate('LAAM', 'XLM');
      const xlmToUsdc = await getExchangeRate('XLM', 'USDC');
      return laamToXlm * xlmToUsdc;
    } else {
      return getFallbackRate(giveAsset, getAsset);
    }
    
    const response = await fetch(url);
    const data = await response.json();
    
    if (data.bids && data.bids.length > 0) {
      return parseFloat(data.bids[0].price);
    } else if (data.asks && data.asks.length > 0) {
      // If no bids, use the ask price (inverse for the opposite direction)
      return 1 / parseFloat(data.asks[0].price);
    } else {
      return getFallbackRate(giveAsset, getAsset);
    }
    
  } catch (error) {
    console.error('Error fetching exchange rate:', error);
    return getFallbackRate(giveAsset, getAsset);
  }
}

// ===== Fallback Exchange Rates =====
function getFallbackRate(giveAsset, getAsset) {
  // Realistic fallback rates based on current market
  const rates = {
    'XLM_USDC': 0.25,      // 1 XLM = 0.25 USDC
    'USDC_XLM': 4.0,       // 1 USDC = 4.0 XLM
    'XLM_LAAM': 7.5,       // 1 XLM = 7.5 LAAM
    'LAAM_XLM': 0.133,     // 1 LAAM = 0.133 XLM
    'USDC_LAAM': 30.0,     // 1 USDC = 30.0 LAAM
    'LAAM_USDC': 0.033     // 1 LAAM = 0.033 USDC
  };
  
  return rates[`${giveAsset}_${getAsset}`] || 1;
}

// ===== Execute Swap =====


// ===== Initialize Swap Modal =====
document.addEventListener("DOMContentLoaded", function () {
  // Open modal
  document.getElementById("swapBtn").addEventListener("click", openSwapModal);

  // Auto-calc on giveAmount input
  document.getElementById("giveAmount").addEventListener("input", calculateSwap);

  // Update when assets change
  document.getElementById("giveAsset").addEventListener("change", function() {
    updateAssetUnits();
    updateSwapBalances();
    calculateSwap();
  });
  
  document.getElementById("getAsset").addEventListener("change", function() {
    updateAssetUnits();
    updateSwapBalances();
    calculateSwap();
  });

  // Swap direction button
  document.getElementById("swapDirectionBtn").addEventListener("click", swapAssetsDirection);

  // Percentage buttons
  document.querySelectorAll('#swapModal .rowBtns button').forEach(btn => {
    btn.addEventListener('click', function() {
      const percentage = parseInt(this.getAttribute('data-fill'));
      const giveAsset = document.getElementById("giveAsset").value;
      const balanceElement = document.getElementById(giveAsset.toLowerCase() + 'Bal');
      
      if (balanceElement) {
        const balance = parseFloat(balanceElement.textContent);
        const amount = (balance * percentage) / 100;
        document.getElementById("giveAmount").value = amount.toFixed(7);
        calculateSwap();
      }
    });
  });

  // Confirm swap execution
  document.getElementById("confirmSwapBtn").addEventListener("click", executeSwap);

  // Close modal when clicking outside
  document.getElementById("swapModal").addEventListener("click", function(e) {
    if (e.target === this) {
      closeSwapModal();
    }
  });
});
// Function to switch trading pairs
function switchTradePair(pair) {
  currentTradePair = pair;
  
  switch(pair) {
    case 'LAAM_XLM':
      currentBaseAsset = LAAM_ASSET;
      currentCounterAsset = StellarSdk.Asset.native();
      updateTradePairDisplay('Laam', 'XLM', LAAM_TOKEN.image, 'https://res.coinpaper.com/coinpaper/stellar_xlm_logo_07021d63c0.png');
      break;
    case 'USDC_XLM':
      currentBaseAsset = USDC_ASSET;
      currentCounterAsset = StellarSdk.Asset.native();
      updateTradePairDisplay('USDC', 'XLM', 'https://i.ibb.co/r2qNFs22/images-2.png', 'https://res.coinpaper.com/coinpaper/stellar_xlm_logo_07021d63c0.png');
      break;
    case 'LAAM_USDC':
      currentBaseAsset = LAAM_ASSET;
      currentCounterAsset = USDC_ASSET;
      updateTradePairDisplay('Laam', 'USDC', LAAM_TOKEN.image, 'https://i.ibb.co/r2qNFs22/images-2.png');
      break;
  }
  
  // Refresh data for new pair
  fetchOrderbook();
  fetchTrades();
  updateOverview();
}

// Update the trade pair display
function updateTradePairDisplay(baseName, counterName, baseImage, counterImage) {
  const assetBoxes = document.querySelectorAll('.trade-asset-selector .asset-box');
  
  if (assetBoxes.length >= 2) {
    // Update base asset (left side)
    assetBoxes[0].innerHTML = `
      <img src="${baseImage}" alt="${baseName}">
      <div>
        <div class="asset-name">${baseName}</div>
        <div class="asset-issuer">${baseName === 'Laam' ? 'laam.online' : 'centre.io'}</div>
      </div>
    `;
    
    // Update counter asset (right side)
    assetBoxes[1].innerHTML = `
      <img src="${counterImage}" alt="${counterName}">
      <div>
        <div class="asset-name">${counterName}</div>
        <div class="asset-issuer">${counterName === 'XLM' ? 'stellar.org' : 'centre.io'}</div>
      </div>
    `;
  }
  
  // Update modal titles and labels
  updateTradeModalLabels(baseName, counterName);
}

// Update trade modal labels based on current pair
function updateTradeModalLabels(baseName, counterName) {
  const modalTitle = document.getElementById('modalTitle');
  const panelTitle = document.getElementById('panelTitle');
  const modalBuyBtn = document.getElementById('modalBuyBtn');
  const priceUnit = document.querySelector('.field .unit');
  const amountUnit = document.querySelectorAll('.field .unit')[1];
  const totalUnit = document.querySelector('.totalBox .unit');
  
  if (modalTitle) {
    modalTitle.textContent = `Buy ${baseName}`;
    panelTitle.textContent = `Buy ${baseName}`;
    modalBuyBtn.textContent = `Buy ${baseName}`;
  }
  
  if (priceUnit) priceUnit.textContent = counterName;
  if (amountUnit) amountUnit.textContent = baseName;
  if (totalUnit) totalUnit.textContent = counterName;
}

    // Your existing utility functions
    function showError(message) {
      const alertBox = document.getElementById("errorAlert");
      if (alertBox) {
        alertBox.textContent = " " + message;
        alertBox.style.display = "block";
        setTimeout(() => {
          alertBox.style.display = "none";
        }, 4000);
      } else {
        alert("Error: " + message);
      }
    }

    function showSuccess(message) {
      const alertBox = document.getElementById("successAlert");
      if (alertBox) {
        alertBox.textContent = " " + message;
        alertBox.style.display = "block";
        setTimeout(() => {
          alertBox.style.display = "none";
        }, 3000);
      }
    }

    function encryptSecretKey(secretKey, password) {
      return CryptoJS.AES.encrypt(secretKey, password).toString();
    }

    function decryptSecretKey(encryptedKey, password) {
      try {
        const bytes = CryptoJS.AES.decrypt(encryptedKey, password);
        return bytes.toString(CryptoJS.enc.Utf8);
      } catch (e) {
        return null;
      }
    }
    // Initialize Stellar SDK
    function initializeStellar() {
      try {
        if (typeof StellarSdk !== 'undefined') {
          server = new StellarSdk.Server('https://horizon.stellar.org');
          console.log('Stellar SDK initialized successfully');
        } else {
          console.error('Stellar SDK not loaded');
          showError('Stellar SDK failed to load. Please refresh the page.');
        }
      } catch (error) {
        console.error('Error initializing Stellar SDK:', error);
        showError('Failed to initialize Stellar SDK: ' + error.message);
      }
    }
    
    function initializeAssets() {
      try {
        if (typeof StellarSdk !== 'undefined') {
          LAAM_ASSET = new StellarSdk.Asset(LAAM_TOKEN.code, LAAM_TOKEN.issuer);
          USDC_ASSET = new StellarSdk.Asset(USDC_TOKEN.code, USDC_TOKEN.issuer);
          console.log('Assets initialized successfully');
        }
      } catch (error) {
        console.error('Error initializing assets:', error);
      }
    }
    
    // Utility functions
    function showError(message) {
  const alertBox = document.getElementById("errorAlert");
  alertBox.textContent = " " + message;
  alertBox.style.display = "block";
  setTimeout(() => {
    alertBox.style.display = "none";
  }, 4000);
      }
function showSuccess(message) {
  const alertBox = document.getElementById("successAlert");
  alertBox.textContent = " " + message;
  alertBox.style.display = "block";
  setTimeout(() => {
    alertBox.style.display = "none";
  }, 3000);
      }
    
    function formatAmount(amount) {
      return parseFloat(amount).toFixed(7);
    }
    
    function encryptSecretKey(secretKey, password) {
      return CryptoJS.AES.encrypt(secretKey, password).toString();
    }
    
    function decryptSecretKey(encryptedKey, password) {
      try {
        const bytes = CryptoJS.AES.decrypt(encryptedKey, password);
        return bytes.toString(CryptoJS.enc.Utf8);
      } catch (e) {
        return null;
      }
    }

    // Copy to clipboard function
    async function copyToClipboard(elementId, buttonElement) {
      try {
        const element = document.getElementById(elementId);
        const text = element.value;
        
        await navigator.clipboard.writeText(text);
        
        const originalText = buttonElement.textContent;
        buttonElement.textContent = 'Copied!';
        buttonElement.classList.add('copied');
        
        setTimeout(() => {
          buttonElement.textContent = originalText;
          buttonElement.classList.remove('copied');
        }, 2000);
        
      } catch (err) {
        console.error('Failed to copy:', err);
        const element = document.getElementById(elementId);
        element.select();
        element.setSelectionRange(0, 99999);
        document.execCommand('copy');
        
        const originalText = buttonElement.textContent;
        buttonElement.textContent = 'Copied!';
        buttonElement.classList.add('copied');
        
        setTimeout(() => {
          buttonElement.textContent = originalText;
          buttonElement.classList.remove('copied');
        }, 2000);
      }
    }

    // Key modal functions
    function openKeyModal(secretKey, publicKey) {
      document.getElementById('generatedSecretKey').value = secretKey;
      document.getElementById('generatedPublicKey').value = publicKey;
      document.getElementById('keyModal').classList.add('show');
    }

    function closeKeyModal() {
      document.getElementById('keyModal').classList.remove('show');
      generatedKeypair = null;
    }

    function useGeneratedAccount() {
      if (generatedKeypair) {
        document.getElementById('secretKeyInput').value = generatedKeypair.secret();
        closeKeyModal();
        showSuccess('Account keys have been filled in the form. Please create a password to save your wallet.');
      }
    }

    // Tab switching functionality
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      document.getElementById(tabName + 'Tab').classList.add('active');
      document.getElementById(tabName + 'Content').classList.add('active');
      
      currentTab = tabName;
      
      if (tabName === 'orderbook') {
        fetchOrderbook();
      } else if (tabName === 'lastTrades') {
        fetchTrades();
      } else if (tabName === 'overview') {
        updateOverview();
      }
    }

    // Fetch XLM price from API
    async function fetchXLMPrice() {
      try {
        const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=stellar&vs_currencies=usd');
        const data = await response.json();
        if (data.stellar && data.stellar.usd) {
          xlmPriceUSD = data.stellar.usd;
          console.log('XLM price updated:', xlmPriceUSD);
        }
      } catch (error) {
        console.error('Error fetching XLM price:', error);
        xlmPriceUSD = 0.12;
      }
    }

    // Create a beautiful price chart
    function createPriceChart() {
      const ctx = document.getElementById('priceChart').getContext('2d');
      
      // Sample price data (in a real app, this would come from an API)
      const prices = [0.12, 0.125, 0.128, 0.13, 0.132, 0.135, 0.133, 0.131, 0.129, 0.127, 0.125, 0.128, 0.13, 0.132, 0.135];
      const labels = Array.from({length: prices.length}, (_, i) => {
        const d = new Date();
        d.setHours(d.getHours() - (prices.length - i - 1));
        return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      });
      
      // Destroy existing chart if it exists
      if (priceChart) {
        priceChart.destroy();
      }
      
      priceChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'LAAM/XLM Price',
            data: prices,
            borderColor: '#1976d2',
            backgroundColor: 'rgba(25, 118, 210, 0.1)',
            borderWidth: 2,
            pointRadius: 3,
            pointBackgroundColor: '#1976d2',
            pointBorderColor: '#fff',
            pointHoverRadius: 5,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(0, 0, 0, 0.7)',
              titleFont: {
                size: 14
              },
              bodyFont: {
                size: 13
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              },
              ticks: {
                maxRotation: 0,
                autoSkip: true,
                maxTicksLimit: 6
              }
            },
            y: {
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              ticks: {
                callback: function(value) {
                  return value.toFixed(3) + ' XLM';
                }
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index',
          }
        }
      });
    }

    // Update overview tab
    function updateOverview() {
      const currentPrice = 0.135000;
      const priceChange = 0.005000;
      const priceChangePercent = ((priceChange / (currentPrice - priceChange)) * 100).toFixed(2);
      
      document.getElementById('overviewLaamPriceXLM').textContent = currentPrice.toFixed(6);
      
      const priceChangeElement = document.getElementById('priceChange');
      priceChangeElement.textContent = `+${priceChange.toFixed(6)} (+${priceChangePercent}%)`;
      priceChangeElement.className = priceChange >= 0 ? 'price-change positive' : 'price-change negative';
      
      // Create or update the price chart
      createPriceChart();
    }

    
   // Enhanced fetchOrderbook for multiple pairs
async function fetchOrderbook() {
  try {
    console.log('Fetching orderbook for pair:', currentTradePair);
    
    // Show loading
    document.getElementById('asksBody').innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;"><div class="loading-spinner"></div> Loading asks...</td></tr>';
    document.getElementById('bidsBody').innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;"><div class="loading-spinner"></div> Loading bids...</td></tr>';
    
    let orderbookUrl;
    
    switch(currentTradePair) {
      case 'LAAM_XLM':
        orderbookUrl = `https://horizon.stellar.org/order_book?selling_asset_type=credit_alphanum4&selling_asset_code=${LAAM_TOKEN.code}&selling_asset_issuer=${LAAM_TOKEN.issuer}&buying_asset_type=native&limit=10`;
        break;
      case 'USDC_XLM':
        orderbookUrl = `https://horizon.stellar.org/order_book?selling_asset_type=credit_alphanum4&selling_asset_code=${USDC_TOKEN.code}&selling_asset_issuer=${USDC_TOKEN.issuer}&buying_asset_type=native&limit=10`;
        break;
      case 'LAAM_USDC':
        orderbookUrl = `https://horizon.stellar.org/order_book?selling_asset_type=credit_alphanum4&selling_asset_code=${LAAM_TOKEN.code}&selling_asset_issuer=${LAAM_TOKEN.issuer}&buying_asset_type=credit_alphanum4&buying_asset_code=${USDC_TOKEN.code}&buying_asset_issuer=${USDC_TOKEN.issuer}&limit=10`;
        break;
    }
    
    const response = await fetch(orderbookUrl);
    const data = await response.json();
    
    console.log('Orderbook API response:', data);
    
    // Clear loading
    document.getElementById('asksBody').innerHTML = '';
    document.getElementById('bidsBody').innerHTML = '';
    
    // Process ASKS (SELL orders)
    const asksBody = document.getElementById('asksBody');
    if (data.asks && data.asks.length > 0) {
      const sortedAsks = [...data.asks].sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
      
      sortedAsks.slice(0, 5).forEach(ask => {
        const amount = parseFloat(ask.amount).toFixed(2);
        const price = parseFloat(ask.price).toFixed(7);
        const total = (parseFloat(ask.amount) * parseFloat(ask.price)).toFixed(7);
        
        const row = document.createElement('tr');
        row.className = 'ask-row';
        row.innerHTML = `
          <td>${amount}</td>
          <td>${price}</td>
          <td>${total}</td>
        `;
        
        row.addEventListener('click', () => {
          if (document.getElementById('tradeModal').classList.contains('show')) {
            document.getElementById('modalPrice').value = price;
            calculateTotal();
          }
        });
        
        asksBody.appendChild(row);
      });
    } else {
      asksBody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:10px; color:#666;">No sell orders</td></tr>';
    }
    
    // Process BIDS (BUY orders)
    const bidsBody = document.getElementById('bidsBody');
    if (data.bids && data.bids.length > 0) {
      const sortedBids = [...data.bids].sort((a, b) => parseFloat(b.price) - parseFloat(a.price));
      
      sortedBids.slice(0, 5).forEach(bid => {
        const baseAmount = (parseFloat(bid.amount) / parseFloat(bid.price)).toFixed(2);
        const price = parseFloat(bid.price).toFixed(7);
        const total = parseFloat(bid.amount).toFixed(7);
        
        const row = document.createElement('tr');
        row.className = 'bid-row';
        row.innerHTML = `
          <td>${baseAmount}</td>
          <td>${price}</td>
          <td>${total}</td>
        `;
        
        row.addEventListener('click', () => {
          if (document.getElementById('tradeModal').classList.contains('show')) {
            document.getElementById('modalPrice').value = price;
            calculateTotal();
          }
        });
        
        bidsBody.appendChild(row);
      });
    } else {
      bidsBody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:10px; color:#666;">No buy orders</td></tr>';
    }
    
    // Calculate spread
    let spread = 'No data';
    if (data.asks && data.asks.length > 0 && data.bids && data.bids.length > 0) {
      const bestAsk = parseFloat(data.asks[0].price);
      const bestBid = parseFloat(data.bids[0].price);
      const spreadValue = bestAsk - bestBid;
      const spreadPercent = ((spreadValue / bestBid) * 100).toFixed(2);
      spread = `Spread: ${spreadValue.toFixed(7)} (${spreadPercent}%)`;
    }
    
    document.getElementById('spreadValue').textContent = spread;
    
  } catch (error) {
    console.error('Error fetching orderbook:', error);
    useRealisticFallbackData();
  }
}

// Realistic fallback data function
function useRealisticFallbackData() {
  const realisticAsks = [
    { amount: '3715.40', price: '0.1365000', total: '507.1521000' }, // SELL orders - Laam amount
    { amount: '2500.00', price: '0.1370000', total: '342.5000000' },
    { amount: '1800.00', price: '0.1380000', total: '248.4000000' },
    { amount: '3200.00', price: '0.1390000', total: '444.8000000' },
    { amount: '1500.00', price: '0.1400000', total: '210.0000000' }
  ];
  
  const realisticBids = [
    // BIDS: Dadka iibsanaya Laam - amount waa Laam, total waa XLM
    { amount: '100.00', price: '0.1350000', total: '13.5000000' }, //  SAX: 100 Laam * 0.135 = 13.5 XLM
    { amount: '75.00', price: '0.1340000', total: '10.0500000' },
    { amount: '50.00', price: '0.1330000', total: '6.6500000' },
    { amount: '120.00', price: '0.1320000', total: '15.8400000' },
    { amount: '90.00', price: '0.1310000', total: '11.7900000' }
  ];
  
  
  const asksBody = document.getElementById('asksBody');
  const bidsBody = document.getElementById('bidsBody');
  
  asksBody.innerHTML = '';
  bidsBody.innerHTML = '';
  
  // Display realistic asks
  realisticAsks.forEach(ask => {
    const row = document.createElement('tr');
    row.className = 'ask-row';
    row.innerHTML = `
      <td>${ask.amount}</td>
      <td>${ask.price}</td>
      <td>${ask.total}</td>
    `;
    asksBody.appendChild(row);
  });
  
  // Display realistic bids
  realisticBids.forEach(bid => {
    const row = document.createElement('tr');
    row.className = 'bid-row';
    row.innerHTML = `
      <td>${bid.amount}</td>
      <td>${bid.price}</td>
      <td>${bid.total}</td>
    `;
    bidsBody.appendChild(row);
  });
  
  document.getElementById('spreadValue').textContent = 'Spread: 0.0015000 XLM (1.11%)';
  
  // Add click events
  document.querySelectorAll('.ask-row, .bid-row').forEach(row => {
    row.addEventListener('click', () => {
      const price = row.children[1].textContent
      if (document.getElementById('tradeModal').classList.contains('show')) {
        document.getElementById('modalPrice').value = price;
        calculateTotal();
      }
    });
  });
}
    // Fetch trades data
    async function fetchTrades() {
      try {
        console.log('Fetching trades data...');
        
        document.getElementById('tradesBody').innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;"><div class="loading-spinner"></div> Loading trades...</td></tr>';
        
        const tradesUrl = `https://horizon.stellar.org/trades?base_asset_type=credit_alphanum4&base_asset_code=${LAAM_TOKEN.code}&base_asset_issuer=${LAAM_TOKEN.issuer}&counter_asset_type=native&limit=20&order=desc`;
        
        const response = await fetch(tradesUrl);
        const data = await response.json();
        
        console.log('Trades data received:', data);
        
        const tradesBody = document.getElementById('tradesBody');
        tradesBody.innerHTML = '';
        
        if (data._embedded && data._embedded.records && data._embedded.records.length > 0) {
          tradesData = data._embedded.records;
          data._embedded.records.slice(0, 10).forEach(trade => {
            const row = document.createElement('tr');
            const time = new Date(trade.ledger_close_time).toLocaleTimeString();
            const type = trade.base_is_seller ? 'SELL' : 'BUY';
            const price = parseFloat(trade.price.n / trade.price.d).toFixed(7);
            const amount = parseFloat(trade.base_amount).toFixed(2);
            
            row.innerHTML = `
              <td class="trade-time">${time}</td>
              <td class="${type.toLowerCase() === 'buy' ? 'trade-buy' : 'trade-sell'}">${type}</td>
              <td>${price}</td>
              <td>${amount}</td>
            `;
            tradesBody.appendChild(row);
          });
        } else {
          const sampleTrades = [
            { time: '14:32:15', type: 'BUY', price: '0.1350000', amount: '250.00' },
            { time: '14:28:42', type: 'SELL', price: '0.1340000', amount: '180.50' },
            { time: '14:25:18', type: 'BUY', price: '0.1345000', amount: '320.75' },
            { time: '14:22:03', type: 'BUY', price: '0.1338000', amount: '150.25' },
            { time: '14:18:47', type: 'SELL', price: '0.1335000', amount: '400.00' },
            { time: '14:15:22', type: 'BUY', price: '0.1342000', amount: '275.50' },
            { time: '14:12:08', type: 'SELL', price: '0.1330000', amount: '190.75' },
            { time: '14:08:35', type: 'BUY', price: '0.1348000', amount: '225.00' }
          ];
          
          sampleTrades.forEach(trade => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td class="trade-time">${trade.time}</td>
              <td class="${trade.type.toLowerCase() === 'buy' ? 'trade-buy' : 'trade-sell'}">${trade.type}</td>
              <td>${trade.price}</td>
              <td>${trade.amount}</td>
            `;
            tradesBody.appendChild(row);
          });
        }
        
        console.log('Trades updated successfully');
        
      } catch (error) {
        console.error('Error fetching trades:', error);
        
        const sampleTrades = [
          { time: '14:32:15', type: 'BUY', price: '0.1350000', amount: '250.00' },
          { time: '14:28:42', type: 'SELL', price: '0.1340000', amount: '180.50' },
          { time: '14:25:18', type: 'BUY', price: '0.1345000', amount: '320.75' },
          { time: '14:22:03', type: 'BUY', price: '0.1338000', amount: '150.25' },
          { time: '14:18:47', type: 'SELL', price: '0.1335000', amount: '400.00' }
        ];
        
        const tradesBody = document.getElementById('tradesBody');
        tradesBody.innerHTML = '';
        
        sampleTrades.forEach(trade => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="trade-time">${trade.time}</td>
            <td class="${trade.type.toLowerCase() === 'buy' ? 'trade-buy' : 'trade-sell'}">${trade.type}</td>
            <td>${trade.price}</td>
            <td>${trade.amount}</td>
          `;
          tradesBody.appendChild(row);
        });
      }
    }

  // Update balance display function
async function updateBalanceDisplay() {
  if (!currentKeypair || !server) {
    console.log('No keypair or server available');
    return;
  }

  try {
    console.log('Loading account data...');
    const account = await server.loadAccount(currentKeypair.publicKey());

    let xlmBalance = 0;
    let laamBalance = 0;
    let usdcBalance = 0;

    account.balances.forEach(balance => {
      if (balance.asset_type === 'native') {
        xlmBalance = parseFloat(balance.balance);
      } else if (
        balance.asset_code === LAAM_TOKEN.code &&
        balance.asset_issuer === LAAM_TOKEN.issuer
      ) {
        laamBalance = parseFloat(balance.balance);
      } else if (
        balance.asset_code === USDC_TOKEN.code &&
        balance.asset_issuer === USDC_TOKEN.issuer
      ) {
        usdcBalance = parseFloat(balance.balance);
      }
    });

    //  XLM price + balance
    document.getElementById('xlmBal').textContent = xlmBalance.toFixed(2);
    document.getElementById('xlmBalUsd').textContent = (xlmBalance * xlmPriceUSD).toFixed(2);
    document.getElementById('xlmPrice').textContent = xlmPriceUSD.toFixed(3);

    // Sample % change (XLM)
    let xlmChange = 2.06;
    const xlmChangeEl = document.getElementById('xlmChange');
    xlmChangeEl.textContent = (xlmChange >= 0 ? '+' : '') + xlmChange.toFixed(2) + '%';
    xlmChangeEl.className = 'price-change ' + (xlmChange >= 0 ? 'positive' : 'negative');

    //  Laam part
    const bestSellOfferXLM = await getBestSellOfferPrice();
    const laamPriceUSD = bestSellOfferXLM * xlmPriceUSD;

    LAAM_TOKEN.currentPrice = laamPriceUSD;

    document.getElementById('laamBal').textContent = laamBalance.toFixed(2);
    document.getElementById('laamBalUsd').textContent = (laamBalance * laamPriceUSD).toFixed(2);
    document.getElementById('laamPrice').textContent = laamPriceUSD.toFixed(6);

    // Sample % change (Laam)
    let laamChange = -12.67;
    const laamChangeEl = document.getElementById('laamChange');
    laamChangeEl.textContent = (laamChange >= 0 ? '+' : '') + laamChange.toFixed(2) + '%';
    laamChangeEl.className = 'price-change ' + (laamChange >= 0 ? 'positive' : 'negative');

    //  USDC part
    document.getElementById('usdcBal').textContent = usdcBalance.toFixed(2);
    document.getElementById('usdcBalUsd').textContent = usdcBalance.toFixed(2);
    document.getElementById('usdcPrice').textContent = "1.00";

    const usdcChangeEl = document.getElementById('usdcChange');
    usdcChangeEl.textContent = "0.00%";
    usdcChangeEl.className = 'price-change';

    updateTotalAssets();

    console.log('Balance display updated successfully');

  } catch (error) {
    console.error('Error updating balance display:', error);
    showError('Failed to load account balance: ' + error.message);
  }
}

// Helper: get best sell offer price (Laam/XLM)
async function getBestSellOfferPrice() {
  try {
    const orderbookUrl = `https://horizon.stellar.org/order_book?selling_asset_type=credit_alphanum4&selling_asset_code=${LAAM_TOKEN.code}&selling_asset_issuer=${LAAM_TOKEN.issuer}&buying_asset_type=native&limit=1`;
    const response = await fetch(orderbookUrl);
    const data = await response.json();

    if (data.asks && data.asks.length > 0) {
      return parseFloat(data.asks[0].price); // best sell offer
    }
  } catch (e) {
    console.error("Failed to fetch best sell offer:", e);
  }
  return LAAM_TOKEN.currentPrice; // fallback
}

// Update total assets value
function updateTotalAssets() {
  const xlmUsd = parseFloat(document.getElementById('xlmBalUsd').textContent) || 0;
  const laamUsd = parseFloat(document.getElementById('laamBalUsd').textContent) || 0;
  const usdcUsd = parseFloat(document.getElementById('usdcBalUsd').textContent) || 0;

  const totalAssets = (xlmUsd + laamUsd + usdcUsd).toFixed(2);
  document.getElementById('totalAssets').textContent = totalAssets;
}
    // Load wallet function
    async function loadWallet() {
      if (!currentKeypair) {
        console.error('No keypair available');
        return;
      }

      try {
        console.log('Loading wallet for:', currentKeypair.publicKey());
        
        await fetchXLMPrice();
        await updateBalanceDisplay();
        
        if (currentTab === 'orderbook') {
          await fetchOrderbook();
        } else if (currentTab === 'lastTrades') {
          await fetchTrades();
        } else if (currentTab === 'overview') {
          updateOverview();
        }
        
        console.log('Wallet loaded successfully');
        
      } catch (error) {
        console.error('Error loading wallet:', error);
        
        // Only show error if wallet view is visible
        if (!document.getElementById('loggedInView').classList.contains('hidden')) {
          showError('Failed to load wallet: ' + error.message);
        }
      }
    }

    // Check if wallet exists in localStorage
    function checkSavedWallet() {
  const encryptedKey = localStorage.getItem('laam_wallet_key');
  const fallbackKey = localStorage.getItem('laam_wallet_biometric_fallback');
  
  if (encryptedKey) {
    document.getElementById('initialView').classList.add('hidden');
    document.getElementById('unlockView').classList.remove('hidden');
    
    // Update fingerprint UI based on fallback availability
    if (fallbackKey) {
      document.getElementById('fingerprintStatus').textContent = 'Fingerprint unlock ready';
      document.getElementById('fingerprintStatus').className = 'fingerprint-status enabled';
      document.getElementById('fingerprintUnlockBtn').disabled = false;
    }
  }
}
 
     // Trade modal functions
    function openTradeModal(mode) {
  currentTradeMode = mode;
  const modal = document.getElementById('tradeModal');
  const title = document.getElementById('modalTitle');
  const panelTitle = document.getElementById('panelTitle');
  const availBalance = document.getElementById('availBalance');
  const modalBuyBtn = document.getElementById('modalBuyBtn');
  
  let baseName, counterName;
  switch (currentTradePair) {
    case 'LAAM_XLM':
      baseName = 'Laam'; counterName = 'XLM'; break;
    case 'USDC_XLM':
      baseName = 'USDC'; counterName = 'XLM'; break;
    case 'LAAM_USDC':
      baseName = 'Laam'; counterName = 'USDC'; break;
  }

  if (mode === 'buy') {
    title.textContent = `Buy ${baseName}`;
    panelTitle.textContent = `Buy ${baseName}`;
    modalBuyBtn.textContent = `Buy ${baseName}`;
    modalBuyBtn.className = 'cta buy';

    const counterBal = document.getElementById(counterName.toLowerCase() + 'Bal').textContent;
    availBalance.textContent = `${counterBal} ${counterName}`;
  } else {
    title.textContent = `Sell ${baseName}`;
    panelTitle.textContent = `Sell ${baseName}`;
    modalBuyBtn.textContent = `Sell ${baseName}`;
    modalBuyBtn.className = 'cta sell';

    const baseBal = document.getElementById(baseName.toLowerCase() + 'Bal').textContent;
    availBalance.textContent = `${baseBal} ${baseName}`;
  }

  modal.classList.add('show');
}

function closeTradeModal() {
  const modal = document.getElementById('tradeModal');
  modal.classList.remove('show');
  document.getElementById('modalPrice').value = '';
  document.getElementById('modalAmount').value = '';
  document.getElementById('modalTotal').value = '';
}

function calculateTotal() {
  const price = parseFloat(document.getElementById('modalPrice').value) || 0;
  const amount = parseFloat(document.getElementById('modalAmount').value) || 0;
  const total = price * amount;
  document.getElementById('modalTotal').value = total.toFixed(7);
}

document.addEventListener('DOMContentLoaded', function() {
  const buyBtn = document.getElementById('buyBtn');
  if (buyBtn) {
    buyBtn.addEventListener('click', () => openTradeModal('buy'));
  }

  const sellBtn = document.getElementById('sellBtn');
  if (sellBtn) {
    sellBtn.addEventListener('click', () => openTradeModal('sell'));
  }

  const closeBtn = document.getElementById('closeTradeModal');
  if (closeBtn) {
    closeBtn.addEventListener('click', closeTradeModal);
  }
});

   // Enhanced createOffer for multiple pairs
function calculateTotal() {
      const price = parseFloat(document.getElementById('modalPrice').value) || 0;
      const amount = parseFloat(document.getElementById('modalAmount').value) || 0;
      const total = price * amount;
      document.getElementById('modalTotal').value = total.toFixed(7);
    }

    // Create offer function
    async function createOffer(mode, amount, price) {
      if (!currentKeypair || !LAAM_ASSET) {
        throw new Error('Wallet not loaded or asset not initialized.');
      }

      try {
        const account = await server.loadAccount(currentKeypair.publicKey());
        
        let operation;
        if (mode === 'buy') {
          operation = StellarSdk.Operation.manageBuyOffer({
            selling: StellarSdk.Asset.native(),
            buying: LAAM_ASSET,
            buyAmount: amount.toString(),
            price: price.toString(),
            offerId: '0'
          });
        } else {
          operation = StellarSdk.Operation.manageSellOffer({
            selling: LAAM_ASSET,
            buying: StellarSdk.Asset.native(),
            amount: amount.toString(),
            price: price.toString(),
            offerId: '0'
          });
        }
        
        const transaction = new StellarSdk.TransactionBuilder(account, {
          fee: StellarSdk.BASE_FEE,
          networkPassphrase: StellarSdk.Networks.PUBLIC
        })
        .addOperation(operation)
        .setTimeout(180)
        .build();
        transaction.sign(currentKeypair);
        
        const result = await server.submitTransaction(transaction);
        return result;
        
      } catch (error) {
        console.error('Trade execution error:', error);
        throw error;
      }
      }
    // Load user offers
    async function loadUserOffers() {
  try {
    if (!currentKeypair || !server) {
      throw new Error('Wallet not loaded');
    }
    
    const offers = await server.offers().forAccount(currentKeypair.publicKey()).call();
    
    const laamOffers = offers.records.filter(offer => {
      const sellingAsset = offer.selling;
      const buyingAsset = offer.buying;
      
      const isSellingLaam = sellingAsset.asset_type !== 'native' && 
                           sellingAsset.asset_code === LAAM_TOKEN.code && 
                           sellingAsset.asset_issuer === LAAM_TOKEN.issuer;
      
      const isBuyingLaam = buyingAsset.asset_type !== 'native' && 
                          buyingAsset.asset_code === LAAM_TOKEN.code && 
                          buyingAsset.asset_issuer === LAAM_TOKEN.issuer;
      
      return isSellingLaam || isBuyingLaam;
    });
    
    return laamOffers;
  } catch (error) {
    console.error('Error loading user offers:', error);
    throw error;
  }
}

    // Edit offer function
async function editOffer(offerId, newAmount, newPrice) {
  try {
    if (!currentKeypair) {
      throw new Error('Wallet not loaded');
    }

    const account = await server.loadAccount(currentKeypair.publicKey());
    const offer = await server.offers().offer(offerId).call();
    
    console.log('Editing offer:', offer);
    
    // Hagaaji qaybta asset creation
    const sellingAsset = offer.selling.asset_type === 'native' 
      ? StellarSdk.Asset.native()
      : new StellarSdk.Asset(offer.selling.asset_code, offer.selling.asset_issuer);
    
    const buyingAsset = offer.buying.asset_type === 'native' 
      ? StellarSdk.Asset.native()
      : new StellarSdk.Asset(offer.buying.asset_code, offer.buying.asset_issuer);
    
    // Go'aami nooca offer-ka (sell ama buy)
    const isSellOffer = offer.selling.asset_code === LAAM_TOKEN.code;
    
    let operation;
    if (isSellOffer) {
      operation = StellarSdk.Operation.manageSellOffer({
        selling: sellingAsset,
        buying: buyingAsset,
        amount: newAmount.toString(),
        price: newPrice.toString(),
        offerId: offerId
      });
    } else {
      operation = StellarSdk.Operation.manageBuyOffer({
        selling: sellingAsset,
        buying: buyingAsset,
        buyAmount: newAmount.toString(),
        price: newPrice.toString(),
        offerId: offerId
      });
    }

    const transaction = new StellarSdk.TransactionBuilder(account, {
      fee: StellarSdk.BASE_FEE,
      networkPassphrase: StellarSdk.Networks.PUBLIC
    })
    .addOperation(operation)
    .setTimeout(180)
    .build();
    
    transaction.sign(currentKeypair);
    const result = await server.submitTransaction(transaction);
    console.log('Edit offer successful:', result);
    return result;
  } catch (error) {
    console.error('Edit offer error:', error);
    throw error;
  }
}
    // Cancel offer function
async function cancelOffer(offerId) {
  try {
    const account = await server.loadAccount(currentKeypair.publicKey());
    const offer = await server.offers().offer(offerId).call();
    
    // Isla hagaajinta asset creation
    const sellingAsset = offer.selling.asset_type === 'native' 
      ? StellarSdk.Asset.native()
      : new StellarSdk.Asset(offer.selling.asset_code, offer.selling.asset_issuer);
    
    const buyingAsset = offer.buying.asset_type === 'native' 
      ? StellarSdk.Asset.native()
      : new StellarSdk.Asset(offer.buying.asset_code, offer.buying.asset_issuer);
    
    const isSellOffer = offer.selling.asset_code === LAAM_TOKEN.code;
    
    let operation;
    if (isSellOffer) {
      operation = StellarSdk.Operation.manageSellOffer({
        selling: sellingAsset,
        buying: buyingAsset,
        amount: '0',
        price: '1',
        offerId: offerId
      });
    } else {
      operation = StellarSdk.Operation.manageBuyOffer({
        selling: sellingAsset,
        buying: buyingAsset,
        buyAmount: '0',
        price: '1',
        offerId: offerId
      });
    }

    const transaction = new StellarSdk.TransactionBuilder(account, {
      fee: StellarSdk.BASE_FEE,
      networkPassphrase: StellarSdk.Networks.PUBLIC
    })
    .addOperation(operation)
    .setTimeout(180)
    .build();
    
    transaction.sign(currentKeypair);
    const result = await server.submitTransaction(transaction);
    return result;
  } catch (error) {
    throw error;
  }
}

    // My Orders Modal functions - Updated for all trading pairs
async function openMyOrdersModal() {
  if (!currentKeypair) {
    showError('Please unlock your wallet first');
    return;
  }
  
  const modal = document.getElementById('myOrdersModal');
  const ordersList = document.getElementById('ordersList');
  
  modal.classList.add('show');
  ordersList.innerHTML = '<div style="text-align:center; padding:20px;"><div class="loading-spinner"></div> Loading orders...</div>';
  
  try {
    const offers = await loadUserOffers();
    
    if (offers.length === 0) {
      ordersList.innerHTML = '<p style="text-align:center; padding:20px; color:#666;">No active orders found</p>';
      return;
    }

    let html = '';
    offers.forEach(offer => {
      const offerDetails = getOfferDetails(offer);
      
      if (!offerDetails) return; // Skip if not a recognized trading pair
      
      const { pair, type, baseAmount, price, total, baseAsset, counterAsset } = offerDetails;

      html += `
        <div class="order-item" data-id="${offer.id}">
          <div style="display: flex; justify-content: space-between; width: 100%;">
            <div style="text-align: left;">
              <div class="order-type ${type}">${type.toUpperCase()}</div>
              <div style="font-size: 14px; color: var(--muted); margin-top: 4px;">
                ${type === 'sell' ? 'Selling' : 'Buying'} ${baseAmount} ${baseAsset}
              </div>
            </div>
            <div style="text-align: right;">
              <div class="order-price" style="font-weight: 600;">${price} ${counterAsset}</div>
              <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
                per ${baseAsset}
              </div>
              <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">
                Total: ${total} ${counterAsset}
              </div>
            </div>
          </div>
        </div>
      `;
    });

    ordersList.innerHTML = html;
    
    // Event listeners for order selection
    document.querySelectorAll('.order-item').forEach(item => {
      item.addEventListener('click', function() {
        document.querySelectorAll('.order-item').forEach(i => i.classList.remove('selected'));
        this.classList.add('selected');
        currentOfferId = this.getAttribute('data-id');
      });
    });
    
  } catch (error) {
    console.error('Error loading offers:', error);
    ordersList.innerHTML = '<p style="text-align:center; padding:20px; color:#dc3545;">Error loading orders</p>';
  }
}

// Helper function to determine offer details for any trading pair
function getOfferDetails(offer) {
  const sellingAsset = offer.selling;
  const buyingAsset = offer.buying;
  
  // Check for LAAM/XLM pair
  if ((sellingAsset.asset_code === LAAM_TOKEN.code && sellingAsset.asset_issuer === LAAM_TOKEN.issuer && buyingAsset.asset_type === 'native') ||
      (buyingAsset.asset_code === LAAM_TOKEN.code && buyingAsset.asset_issuer === LAAM_TOKEN.issuer && sellingAsset.asset_type === 'native')) {
    
    const isSell = sellingAsset.asset_code === LAAM_TOKEN.code;
    const baseAmount = isSell ? parseFloat(offer.amount).toFixed(2) : (parseFloat(offer.amount) * parseFloat(offer.price)).toFixed(2);
    const price = isSell ? parseFloat(offer.price).toFixed(7) : (1 / parseFloat(offer.price)).toFixed(7);
    const total = (parseFloat(price) * parseFloat(baseAmount)).toFixed(7);
    
    return {
      pair: 'LAAM_XLM',
      type: isSell ? 'sell' : 'buy',
      baseAmount: baseAmount,
      price: price,
      total: total,
      baseAsset: 'Laam',
      counterAsset: 'XLM'
    };
  }
  
  // Check for USDC/XLM pair
  if ((sellingAsset.asset_code === USDC_TOKEN.code && sellingAsset.asset_issuer === USDC_TOKEN.issuer && buyingAsset.asset_type === 'native') ||
      (buyingAsset.asset_code === USDC_TOKEN.code && buyingAsset.asset_issuer === USDC_TOKEN.issuer && sellingAsset.asset_type === 'native')) {
    
    const isSell = sellingAsset.asset_code === USDC_TOKEN.code;
    const baseAmount = isSell ? parseFloat(offer.amount).toFixed(2) : (parseFloat(offer.amount) * parseFloat(offer.price)).toFixed(2);
    const price = isSell ? parseFloat(offer.price).toFixed(7) : (1 / parseFloat(offer.price)).toFixed(7);
    const total = (parseFloat(price) * parseFloat(baseAmount)).toFixed(7);
    
    return {
      pair: 'USDC_XLM',
      type: isSell ? 'sell' : 'buy',
      baseAmount: baseAmount,
      price: price,
      total: total,
      baseAsset: 'USDC',
      counterAsset: 'XLM'
    };
  }
  
  // Check for LAAM/USDC pair
  if ((sellingAsset.asset_code === LAAM_TOKEN.code && sellingAsset.asset_issuer === LAAM_TOKEN.issuer && 
       buyingAsset.asset_code === USDC_TOKEN.code && buyingAsset.asset_issuer === USDC_TOKEN.issuer) ||
      (buyingAsset.asset_code === LAAM_TOKEN.code && buyingAsset.asset_issuer === LAAM_TOKEN.issuer && 
       sellingAsset.asset_code === USDC_TOKEN.code && sellingAsset.asset_issuer === USDC_TOKEN.issuer)) {
    
    const isSell = sellingAsset.asset_code === LAAM_TOKEN.code;
    const baseAmount = isSell ? parseFloat(offer.amount).toFixed(2) : (parseFloat(offer.amount) * parseFloat(offer.price)).toFixed(2);
    const price = isSell ? parseFloat(offer.price).toFixed(7) : (1 / parseFloat(offer.price)).toFixed(7);
    const total = (parseFloat(price) * parseFloat(baseAmount)).toFixed(7);
    
    return {
      pair: 'LAAM_USDC',
      type: isSell ? 'sell' : 'buy',
      baseAmount: baseAmount,
      price: price,
      total: total,
      baseAsset: 'Laam',
      counterAsset: 'USDC'
    };
  }
  
  return null; // Unknown trading pair
}

// Enhanced loadUserOffers function to include all pairs
async function loadUserOffers() {
  try {
    if (!currentKeypair || !server) {
      throw new Error('Wallet not loaded');
    }
    
    const offers = await server.offers().forAccount(currentKeypair.publicKey()).call();
    
    // Filter offers to include all trading pairs (LAAM/XLM, USDC/XLM, LAAM/USDC)
    const tradingOffers = offers.records.filter(offer => {
      const sellingAsset = offer.selling;
      const buyingAsset = offer.buying;
      
      // Check for LAAM/XLM
      const isLaamXlm = (sellingAsset.asset_code === LAAM_TOKEN.code && sellingAsset.asset_issuer === LAAM_TOKEN.issuer && buyingAsset.asset_type === 'native') ||
                        (buyingAsset.asset_code === LAAM_TOKEN.code && buyingAsset.asset_issuer === LAAM_TOKEN.issuer && sellingAsset.asset_type === 'native');
      
      // Check for USDC/XLM
      const isUsdcXlm = (sellingAsset.asset_code === USDC_TOKEN.code && sellingAsset.asset_issuer === USDC_TOKEN.issuer && buyingAsset.asset_type === 'native') ||
                        (buyingAsset.asset_code === USDC_TOKEN.code && buyingAsset.asset_issuer === USDC_TOKEN.issuer && sellingAsset.asset_type === 'native');
      
      // Check for LAAM/USDC
      const isLaamUsdc = (sellingAsset.asset_code === LAAM_TOKEN.code && sellingAsset.asset_issuer === LAAM_TOKEN.issuer && 
                          buyingAsset.asset_code === USDC_TOKEN.code && buyingAsset.asset_issuer === USDC_TOKEN.issuer) ||
                         (buyingAsset.asset_code === LAAM_TOKEN.code && buyingAsset.asset_issuer === LAAM_TOKEN.issuer && 
                          sellingAsset.asset_code === USDC_TOKEN.code && sellingAsset.asset_issuer === USDC_TOKEN.issuer);
      
      return isLaamXlm || isUsdcXlm || isLaamUsdc;
    });
    
    return tradingOffers;
  } catch (error) {
    console.error('Error loading user offers:', error);
    throw error;
  }
}

// Enhanced edit offer prompt for all pairs
async function promptEditOffer() {
  if (!currentOfferId) {
    showError('Please select an order first');
    return;
  }
  
  try {
    const offer = await server.offers().offer(currentOfferId).call();
    const offerDetails = getOfferDetails(offer);
    
    if (!offerDetails) {
      showError('Unknown trading pair');
      return;
    }
    
    currentOfferType = offerDetails.type;
    
    let displayAmount, displayPrice;
    if (currentOfferType === 'sell') {
      // SELL  amount waa base asset
      displayAmount = parseFloat(offer.amount).toFixed(7);
      displayPrice = parseFloat(offer.price).toFixed(7);
    } else {
      // BUY  amount waa base asset uu rabo
      displayAmount = (parseFloat(offer.amount) * parseFloat(offer.price)).toFixed(7);
      displayPrice = (1 / parseFloat(offer.price)).toFixed(7);
    }
    
    document.getElementById('editAmount').value = displayAmount;
    document.getElementById('editPrice').value = displayPrice;
    
    // Update modal labels based on trading pair
    const amountLabel = document.querySelector('#editOrderModal label[for="editAmount"]');
    const priceLabel = document.querySelector('#editOrderModal label[for="editPrice"]');
    
    if (amountLabel) amountLabel.textContent = `Amount (${offerDetails.baseAsset})`;
    if (priceLabel) priceLabel.textContent = `Price (${offerDetails.counterAsset} per ${offerDetails.baseAsset})`;
    
    document.getElementById('editOrderModal').classList.add('show');
  } catch (error) {
    console.error('Error loading offer details:', error);
    showError('Failed to load offer details: ' + error.message);
  }
}

function closeMyOrdersModal() {
  const modal = document.getElementById('myOrdersModal');
  modal.classList.remove('show');
  currentOfferId = null;
}

function closeEditModal() {
  document.getElementById('editOrderModal').classList.remove('show');
  document.getElementById('editAmount').value = '';
  document.getElementById('editPrice').value = '';
  currentOfferId = null;
  currentOfferType = null;
}

// Confirm cancel offer - works for all pairs
async function confirmCancelOffer() {
  if (!currentOfferId) {
    showError('Please select an order first');
    return;
  }
  
  if (confirm('Are you sure you want to cancel this order?')) {
    try {
      await cancelOffer(currentOfferId);
      showSuccess('Order cancelled successfully!');
      closeMyOrdersModal();
      // Refresh the orders list
      await openMyOrdersModal();
    } catch (error) {
      showError('Failed to cancel order: ' + error.message);
    }
  }
}
    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, initializing...');
      
      initializeStellar();
      initializeAssets();
      
      if (typeof StellarSdk === 'undefined') {
        console.error('StellarSdk is not defined');
        showError('Stellar SDK failed to load. Please refresh the page.');
        return;
      }
      
      if (typeof CryptoJS === 'undefined') {
        console.error('CryptoJS is not defined');
        showError('CryptoJS failed to load. Please refresh the page.');
        return;
      }
// Add click event listeners to asset items
document.querySelectorAll('.clickable-asset').forEach(item => {
  item.addEventListener('click', function() {
    const token = this.getAttribute('data-token');
    openTokenModal(token);
  });
});

// Close modal when clicking outside
document.getElementById('tokenModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeTokenModal();
  }
});

  // KU DAR event listener-kan halkaan (qaybta DOMContentLoaded)
document.getElementById('confirmEditBtn').addEventListener('click', async function() {
  const newAmount = parseFloat(document.getElementById('editAmount').value);
  const newPrice = parseFloat(document.getElementById('editPrice').value);
  
  if (!newAmount || !newPrice || newAmount <= 0 || newPrice <= 0) {
    showError('Please enter valid amount and price');
    return;
  }
  
  if (!currentOfferId) {
    showError('No order selected');
    return;
  }
  
  this.disabled = true;
  this.textContent = 'Updating...';
  
  try {
    await editOffer(currentOfferId, newAmount, newPrice);
    showSuccess('Order updated successfully!');
    closeEditModal();
    closeMyOrdersModal();
    
    // Dib u soo celi orderbook iyo balances
    await fetchOrderbook();
    await updateBalanceDisplay();
    
  } catch (error) {
    console.error('Edit order error:', error);
    showError('Failed to update order: ' + error.message);
  } finally {
    this.disabled = false;
    this.textContent = 'Update Order';
  }
});
      // Habkan waa ka fiican - ma beddelayo innerHTML
const myOrdersBtn = document.createElement('span');
myOrdersBtn.className = 'icon';
myOrdersBtn.id = 'myOrdersBtn';
myOrdersBtn.textContent = '';
myOrdersBtn.onclick = openMyOrdersModal;
      
console.log('All libraries loaded successfully');
      
      checkSavedWallet();
      
      document.querySelectorAll('.form-input').forEach(input => {
        input.addEventListener('focus', function() {
          this.parentElement.style.transform = 'scale(1.02)';
        });
        
        input.addEventListener('blur', function() {
          this.parentElement.style.transform = 'scale(1)';
        });
      });

      // Ku dar qaybtaan halkaa "Import and Save"
document.getElementById('importAndSaveBtn').addEventListener('click', async function(e) {
  e.preventDefault();
  
  const secretKey = document.getElementById('secretKeyInput').value.trim();
  const password = document.getElementById('savePasswordInput').value;
  
  if (!secretKey.startsWith('S') || secretKey.length !== 56) {
    showError('Invalid secret key format.');
    return;
  }
  
  if (password.length < 8) {
    showError('Password must be at least 8 characters long.');
    return;
  }
  
  this.textContent = 'Importing...';
  this.disabled = true;
  
  try {
    currentKeypair = StellarSdk.Keypair.fromSecret(secretKey);
    
    // 1. Save with password (original)
    const encryptedKey = encryptSecretKey(secretKey, password);
    localStorage.setItem('laam_wallet_key', encryptedKey);
    localStorage.setItem('laam_wallet_public', currentKeypair.publicKey());
    
    // 2. Create BIOMETRIC FALLBACK (NEW)
    const biometricKey = CryptoJS.SHA256(currentKeypair.publicKey() + "biometric_fallback").toString();
    const biometricEncryptedKey = encryptSecretKey(secretKey, biometricKey);
    localStorage.setItem('laam_wallet_biometric_fallback', biometricEncryptedKey);
    
    await loadWallet();
    
    showSuccess('Wallet imported successfully! Biometric setup ready.');
    document.getElementById('authSection').classList.add('hidden');
    document.getElementById('loggedInView').classList.remove('hidden');
    
  } catch (error) {
    console.error('Import error:', error);
    showError('Failed to import wallet: ' + error.message);
  } finally {
    this.textContent = 'Import and Save';
    this.disabled = false;
  }
});
      
      document.getElementById('generateAccountBtn').addEventListener('click', function() {
        console.log('Generate account button clicked');
        
        try {
          generatedKeypair = StellarSdk.Keypair.random();
          const secretKey = generatedKeypair.secret();
          const publicKey = generatedKeypair.publicKey();
          
          console.log('New keypair generated successfully');
          
          openKeyModal(secretKey, publicKey);
          
        } catch (error) {
          console.error('Generate account error:', error);
          showError('Failed to generate account: ' + error.message);
        }
      });
      
      document.getElementById('unlockBtn').addEventListener('click', async function() {
        const password = document.getElementById('walletPassword').value;
        const encryptedKey = localStorage.getItem('laam_wallet_key');
        
        if (!encryptedKey) {
          showError('No wallet found. Please import a wallet first.');
          return;
        }
        
        if (!password) {
          showError('Please enter your password.');
          return;
        }
        
        this.textContent = 'Unlocking...';
        this.disabled = true;
        
        try {
          const decryptedKey = decryptSecretKey(encryptedKey, password);
          
          if (!decryptedKey) {
            showError('Incorrect password.');
            return;
          }
          
          currentKeypair = StellarSdk.Keypair.fromSecret(decryptedKey);
          
          await loadWallet();
          watchDeposits();
         
         function watchDeposits() {
  if (!currentKeypair) {
    console.warn("No wallet loaded, cannot watch deposits.");
    return;
  }

  const publicKey = currentKeypair.publicKey();
  console.log(" Watching deposits for:", publicKey);

  server.payments()
    .forAccount(publicKey)
    .cursor("now") // wixii cusub kadib unlock
    .stream({
      onmessage: function (payment) {
        let destination = null;

        // Payment ama create_account ayaa noqon kara
        if (payment.type === "payment") {
          destination = payment.to;
        } else if (payment.type === "create_account") {
          destination = payment.account;
        }

        if (destination === publicKey) {
          const amount = payment.amount;
          const asset = payment.asset_type === "native" ? "XLM" : payment.asset_code;

          console.log(" Deposit received:", amount, asset);
          showDepositNotification(amount, asset);
        }
      },
      onerror: function (err) {
        console.error("Deposit stream error:", err);
      }
    });
}

function showDepositNotification(amount, asset) {
  const notif = document.createElement("div");
  notif.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #4caf50;
    color: white;
    padding: 14px 20px;
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    z-index: 99999;
    font-weight: 600;
    font-family: sans-serif;
    font-size: 14px;
    animation: slideIn 0.3s ease-out;
  `;
  notif.textContent = ` Deposit of ${amount} ${asset} received`;
  document.body.appendChild(notif);

  setTimeout(() => notif.remove(), 6000);
}

// Animation
const style = document.createElement("style");
style.innerHTML = `
@keyframes slideIn {
  from { transform: translateX(120%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}`;
       
document.head.appendChild(style);

// TokenModal Functions
    function openTokenModal(token) {
      selectedToken = token;
      
      // Set modal content based on token
      const modalTokenName = document.getElementById('modalTokenName');
      const modalTokenIcon = document.getElementById('modalTokenIcon');
      const modalTokenBalance = document.getElementById('modalTokenBalance');
      const modalTokenValue = document.getElementById('modalTokenValue');
      
      // Set token details
      modalTokenName.textContent = token;
      
      // Set token icon
      if (token === 'XLM') {
        modalTokenIcon.src = 'https://res.coinpaper.com/coinpaper/stellar_xlm_logo_07021d63c0.png';
      } else if (token === 'LAAM') {
        modalTokenIcon.src = 'https://i.ibb.co/r28SP1bN/20250802-225108.png';
      } else if (token === 'USDC') {
        modalTokenIcon.src = 'https://i.ibb.co/r2qNFs22/images-2.png';
      }
      
      // Set token balance and value
      const balanceElement = document.getElementById(token.toLowerCase() + 'Bal');
      const valueElement = document.getElementById(token.toLowerCase() + 'BalUsd');
      
      modalTokenBalance.textContent = balanceElement ? balanceElement.textContent + ' ' + token : '0 ' + token;
      modalTokenValue.textContent = valueElement ? '$' + valueElement.textContent : '$0.00';
      
      // Show modal
      document.getElementById('tokenModal').classList.add('show');
    }

    function closeTokenModal() {
      document.getElementById('tokenModal').classList.remove('show');
      selectedToken = null;
    }

    // Open Send Wizard for selected token
    function openSendWizardForToken() {
      if (selectedToken) {
        // Set the asset in send wizard
        document.getElementById('sendAsset').value = selectedToken;
        closeTokenModal();
        
        // Open send wizard
        document.getElementById('sendWizard').style.display = 'block';
        document.getElementById('wizardOverlay').style.display = 'block';
        showStep(1);
      }
    }

    // Open Receive for selected token
    function openReceiveForToken() {
      closeTokenModal();
      
      // Show receive address modal
      const publicKey = currentKeypair ? currentKeypair.publicKey() : "GB7WZHXV4FCATLV2LZFLYU7A74BD5WALPUMOU4CY4DRJGJIL3EW3DGXA";

      const receiveModal = document.createElement('div');
      receiveModal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.7);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
      `;

      receiveModal.innerHTML = `
          <div style="background: white; padding: 25px; border-radius: 20px; text-align: center; max-width: 320px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
              <h3 style="color: #1976d2; margin-top: 0; margin-bottom: 20px;">Receive ${selectedToken}</h3>
              <div style="background: white; padding: 15px; margin: 15px 0; border-radius: 12px; border: 1px solid #e0e0e0;">
                  <img src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${publicKey}" 
                       alt="QR Code" style="max-width: 180px; border-radius: 8px;">
              </div>
              <div style="font-size: 14px; color: #666; margin-bottom: 10px;">Scan this QR code or copy the address below</div>
              <div id="publicKeyText" class="mono" 
                   style="font-size: 13px; margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 12px; word-break: break-all; line-height: 1.5;">
                  ${publicKey}
              </div>
              <button id="btnCopy" 
                      style="background: #4caf50; color: white; border: none; padding: 10px 22px; 
                             border-radius: 12px; cursor: pointer; font-weight: 600; margin-top: 10px; margin-right: 10px;">
                  Copy
              </button>
              <button onclick="this.parentElement.parentElement.remove()" 
                      style="background: #1976d2; color: white; border: none; padding: 12px 24px; 
                             border-radius: 12px; cursor: pointer; font-weight: 600; margin-top: 10px;">
                     Close
              </button>
          </div>
      `;

      document.body.appendChild(receiveModal);

      // Add event listener to the Copy button
      document.getElementById("btnCopy").addEventListener("click", function () {
          copyToClipboard("publicKeyText");
      });
    }

    // Copy to clipboard function
    async function copyToClipboard(elementId) {
      try {
        const element = document.getElementById(elementId);
        const text = element.textContent;
        
        await navigator.clipboard.writeText(text);
        showToast('Copied to clipboard!');
      } catch (err) {
        console.error('Failed to copy:', err);
        // Fallback for older browsers
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand("copy");
        document.body.removeChild(textArea);
        showToast('Copied to clipboard!');
      }
    }

    // Toast notification
    function showToast(message) {
      const toast = document.createElement("div");
      toast.textContent = message;
      toast.style.cssText = `
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        background: #333; color: #fff; padding: 10px 20px; border-radius: 8px;
        font-size: 14px; z-index: 10001; opacity: 0; transition: opacity 0.3s;
      `;
      document.body.appendChild(toast);
      setTimeout(() => { toast.style.opacity = "1"; }, 50);
      setTimeout(() => { toast.style.opacity = "0"; }, 2000);
      setTimeout(() => { toast.remove(); }, 2500);
    }

    // Add event listeners when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      initializeStellar();
      
function debugFingerprintFlow() {
  console.log('=== Fingerprint Debug ===');
  console.log('1. Fingerprint supported:', fingerprintAuth.isSupported);
  console.log('2. Fingerprint setup:', fingerprintAuth.isSetup);
  console.log('3. Stored credential:', !!fingerprintAuth.credentialId);
  console.log('4. Main wallet key:', !!localStorage.getItem('laam_wallet_key'));
  console.log('5. Fallback key:', !!localStorage.getItem('laam_wallet_biometric_fallback'));
  console.log('6. Current keypair:', !!currentKeypair);
}

async function testFingerprintUnlock() {
  console.log(' Testing fingerprint unlock...');
  debugFingerprintFlow();
  
  try {
    await fingerprintAuth.authenticate();
    console.log(' Test passed - authentication successful');
  } catch (error) {
    console.log(' Test failed:', error.message);
  }
}
      // Add click event listeners to asset items
      document.querySelectorAll('.asset-item').forEach(item => {
        item.addEventListener('click', function() {
          const token = this.getAttribute('data-token');
          openTokenModal(token);
        });
      });
      
      // Close modal when clicking outside
      document.getElementById('tokenModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeTokenModal();
        }
      });

      // Waxyaabaha kale ee initialization
      // ...
    });

    // Send Wizard Functions (halkani waa tusaale, waxaad ku daraysaa function-kaaga send)
    function showStep(step) {
      // Implementation for wizard steps
      console.log('Show step:', step);
    }
          
          showSuccess('Wallet unlocked successfully!');
          document.getElementById('authSection').classList.add('hidden');
          document.getElementById('loggedInView').classList.remove('hidden');
          
        } catch (error) {
          console.error('Unlock error:', error);
          showError('Failed to unlock wallet: ' + error.message);
        } finally {
          this.textContent = 'Unlock';
          this.disabled = false;
        }
      });
document.getElementById('resetWalletLink').addEventListener('click', function(e) {
  e.preventDefault();
  
  if (confirm('Are you sure you want to reset? This will remove your current wallet from this device.')) {
    // Ka saar xogta kaydsan
    localStorage.removeItem('laam_wallet_key');
    localStorage.removeItem('laam_wallet_public');
    localStorage.removeItem('laam_wallet_biometric_fallback');
    
    // Reset variables gudaha
    currentKeypair = null;
    
    // Isku day in la nadiifiyo views
    document.getElementById('unlockView').classList.add('hidden');
    document.getElementById('initialView').classList.remove('hidden');
    
    // Nadiifi inputs haddii ay jiraan
    const walletPassword = document.getElementById('walletPassword');
    const secretKeyInput = document.getElementById('secretKeyInput');
    const savePasswordInput = document.getElementById('savePasswordInput');
    
    if (walletPassword) walletPassword.value = '';
    if (secretKeyInput) secretKeyInput.value = '';
    if (savePasswordInput) savePasswordInput.value = '';
    
    // Show message
    showSuccess('Wallet reset successfully. You can now import a new wallet.');
  }
});  
    
      document.getElementById('logoutBtn').addEventListener('click', function() {
        currentKeypair = null;
        
        document.getElementById('loggedInView').classList.add('hidden');
        document.getElementById('authSection').classList.remove('hidden');
        
        const encryptedKey = localStorage.getItem('laam_wallet_key');
        if (encryptedKey) {
          document.getElementById('initialView').classList.add('hidden');
          document.getElementById('unlockView').classList.remove('hidden');
        } else {
          document.getElementById('unlockView').classList.add('hidden');
          document.getElementById('initialView').classList.remove('hidden');
        }
      });
      
      
       
      // Event listener for the Receive button
document.getElementById('btnReceive').addEventListener('click', function () {
    const publicKey = currentKeypair ? currentKeypair.publicKey() : "GB7WZHXV4FCATLV2LZFLYU7A74BD5WALPUMOU4CY4DRJGJIL3EW3DGXA";

    const receiveModal = document.createElement('div');
    receiveModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    `;

    receiveModal.innerHTML = `
        <div style="background: white; padding: 25px; border-radius: 20px; text-align: center; max-width: 320px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            <h3 style="color: #1976d2; margin-top: 0; margin-bottom: 20px;">Your Receive Address</h3>
            <div style="background: white; padding: 15px; margin: 15px 0; border-radius: 12px; border: 1px solid #e0e0e0;">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${publicKey}" 
                     alt="QR Code" style="max-width: 180px; border-radius: 8px;">
            </div>
            <div style="font-size: 14px; color: #666; margin-bottom: 10px;">Scan this QR code or copy the address below</div>
            <div id="publicKeyText" class="mono" 
                 style="font-size: 13px; margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 12px; word-break: break-all; line-height: 1.5;">
                ${publicKey}
            </div>
            <button id="btnCopy" 
                    style="background: #4caf50; color: white; border: none; padding: 10px 22px; 
                           border-radius: 12px; cursor: pointer; font-weight: 600; margin-top: 10px; margin-right: 10px;">
                Copy
            </button>
            <button onclick="this.parentElement.parentElement.remove()" 
                    style="background: #1976d2; color: white; border: none; padding: 12px 24px; 
                           border-radius: 12px; cursor: pointer; font-weight: 600; margin-top: 10px;">
                   
            </button>
        </div>
    `;

    document.body.appendChild(receiveModal);

    // Add event listener to the Copy button
    document.getElementById("btnCopy").addEventListener("click", function () {
        copyToClipboard("publicKeyText");
    });
});

// Copy helper using toast
function copyToClipboard(elementId) {
    try {
        const text = document.getElementById(elementId).textContent.trim();

        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                showToast("Copied to clipboard!");
            }).catch(err => {
                fallbackCopy(text);
            });
        } else {
            fallbackCopy(text);
        }
    } catch (err) {
        console.error("Copy error:", err);
        showToast("Copy failed!");
    }
}

function fallbackCopy(text) {
    const textarea = document.createElement("textarea");
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    textarea.setSelectionRange(0, 99999);
    const successful = document.execCommand('copy');
    document.body.removeChild(textarea);
    if (successful) {
        showToast("Copied to clipboard!");
    } else {
        showToast("Copy failed!");
    }
}

// Toast helper (ku dar haddii aadan hore u haysan)
function showToast(message) {
    const toast = document.createElement("div");
    toast.textContent = message;
    toast.style.cssText = `
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: #333; color: #fff; padding: 10px 20px; border-radius: 8px;
      font-size: 14px; z-index: 10001; opacity: 0; transition: opacity 0.3s;
    `;
    document.body.appendChild(toast);
    setTimeout(() => { toast.style.opacity = "1"; }, 50);
    setTimeout(() => { toast.style.opacity = "0"; }, 2000);
    setTimeout(() => { toast.remove(); }, 2500);
     }
    

      // Tab switching event listeners
      document.getElementById('overviewTab').addEventListener('click', () => switchTab('overview'));
      document.getElementById('orderbookTab').addEventListener('click', () => switchTab('orderbook'));
      document.getElementById('lastTradesTab').addEventListener('click', () => switchTab('lastTrades'));

      // Timeframe button event listeners
      document.querySelectorAll('.timeframe-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          // Update chart with selected timeframe
          const timeframe = this.getAttribute('data-timeframe');
          createRealPriceChart(timeframe);
        });
      });

      // Trade button functionality
      document.getElementById('btnBuy').addEventListener('click', function() {
        console.log('Buy button clicked');
        openTradeModal('buy');
      });

      document.getElementById('btnSell').addEventListener('click', function() {
        console.log('Sell button clicked');
        openTradeModal('sell');
      });

      // Modal price/amount calculation
      document.getElementById('modalPrice').addEventListener('input', calculateTotal);
      document.getElementById('modalAmount').addEventListener('input', calculateTotal);

      // Percentage buttons in modal
      document.querySelectorAll('.rowBtns button').forEach(btn => {
        btn.addEventListener('click', function() {
          const percentage = parseInt(this.getAttribute('data-fill'));
          const availText = document.getElementById('availBalance').textContent;
          const availAmount = parseFloat(availText.split(' ')[0]);
          const price = parseFloat(document.getElementById('modalPrice').value) || 0;
          
          if (currentTradeMode === 'buy' && price > 0) {
            const xlmToSpend = (availAmount * percentage) / 100;
            const laamAmount = xlmToSpend / price;
            document.getElementById('modalAmount').value = laamAmount.toFixed(7);
          } else if (currentTradeMode === 'sell') {
            const laamToSell = (availAmount * percentage) / 100;
            document.getElementById('modalAmount').value = laamToSell.toFixed(7);
          }
          
          calculateTotal();
        });
      });

      // Modal execute trade button
      document.getElementById('modalBuyBtn').addEventListener('click', async function() {
        const price = parseFloat(document.getElementById('modalPrice').value);
        const amount = parseFloat(document.getElementById('modalAmount').value);
        
        if (!price || !amount) {
          showError('Please enter both price and amount.');
          return;
        }
        
        if (!currentKeypair) {
          showError('Wallet not loaded.');
          return;
        }
        
        const availText = document.getElementById('availBalance').textContent;
        const availAmount = parseFloat(availText.split(' ')[0]);
        
        if (currentTradeMode === 'buy') {
          const totalCost = price * amount;
          if (totalCost > availAmount) {
            showError('Insufficient XLM balance for this trade.');
            return;
          }
        } else {
          if (amount > availAmount) {
            showError('Insufficient Laam balance for this trade.');
            return;
          }
        }
        
        this.disabled = true;
        this.textContent = currentTradeMode === 'buy' ? 'Placing Buy Order...' : 'Placing Sell Order...';
        
        try {
          const result = await createOffer(currentTradeMode, amount, price);
          
          showSuccess(`${currentTradeMode === 'buy' ? 'Buy' : 'Sell'} order placed successfully!\n\nTransaction Hash: ${result.hash}\n\nAmount: ${amount} Laam\nPrice: ${price} XLM per Laam\nTotal: ${(price * amount).toFixed(7)} XLM`);
          
          closeTradeModal();
          
          await updateBalanceDisplay();
          if (currentTab === 'orderbook') {
            await fetchOrderbook();
          }
          
        } catch (error) {
          console.error('Trade error:', error);
          showError('Failed to execute trade: ' + error.message);
        } finally {
          this.disabled = false;
          this.textContent = currentTradeMode === 'buy' ? 'Buy Laam' : 'Sell Laam';
        }
      });
      
      // Confirm edit button
      document.getElementById('confirmEditBtn').addEventListener('click', async function() {
        const newAmount = document.getElementById('editAmount').value;
        const newPrice = document.getElementById('editPrice').value;
        
        if (!newAmount || !newPrice) {
          showError('Please enter both amount and price');
          return;
        }
        
        this.disabled = true;
        this.textContent = 'Updating...';
        
        try {
          await editOffer(currentOfferId, newAmount, newPrice);
          showSuccess('Order updated successfully!');
          closeEditModal();
          await openMyOrdersModal();
        } catch (error) {
          showError('Failed to update order: ' + error.message);
        } finally {
          this.disabled = false;
          this.textContent = 'Update Order';
        }
      });
      
      console.log('All event listeners attached successfully');
    });

    // Auto-refresh balance, price, and current tab data every 30 seconds
    setInterval(async () => {
      if (currentKeypair && !document.getElementById('loggedInView').classList.contains('hidden')) {
        await fetchXLMPrice();
        await updateBalanceDisplay();
        
        if (currentTab === 'orderbook') {
          await fetchOrderbook();
        } else if (currentTab === 'lastTrades') {
          await fetchTrades();
        } else if (currentTab === 'overview') {
          updateOverview();
        }
      }
    }, 30000);

    // Fetch real-time Laam/XLM price from Stellar DEX
    async function fetchLaamPrice() {
      try {
        const orderbookUrl = `https://horizon.stellar.org/order_book?selling_asset_type=credit_alphanum4&selling_asset_code=${LAAM_TOKEN.code}&selling_asset_issuer=${LAAM_TOKEN.issuer}&buying_asset_type=native&limit=1`;
        
        const response = await fetch(orderbookUrl);
        const data = await response.json();
        
        if (data.bids && data.bids.length > 0 && data.asks && data.asks.length > 0) {
          const bestBid = parseFloat(data.bids[0].price);
          const bestAsk = parseFloat(data.asks[0].price);
          const currentPrice = (bestBid + bestAsk) / 2;
          
          return {
            price: currentPrice,
            bid: bestBid,
            ask: bestAsk
          };
        }
        
        return { price: 0.06, bid: 0.06, ask: 0.06 }; // Fallback to default price
      } catch (error) {
        console.error('Error fetching Laam price:', error);
        return { price: 0.06, bid: 0.06, ask: 0.06 }; // Fallback to default price
      }
    }

    // Fetch trade history for Laam/XLM
    async function fetchTradeHistory(limit = 100) {
      try {
        const tradesUrl = `https://horizon.stellar.org/trades?base_asset_type=credit_alphanum4&base_asset_code=${LAAM_TOKEN.code}&base_asset_issuer=${LAAM_TOKEN.issuer}&counter_asset_type=native&limit=${limit}&order=desc`;
        
        const response = await fetch(tradesUrl);
        const data = await response.json();
        
        if (data._embedded && data._embedded.records) {
          return data._embedded.records;
        }
        
        return [];
      } catch (error) {
        console.error('Error fetching trade history:', error);
        return [];
      }
    }

    // Calculate 24h stats from trade history
    function calculate24hStats(trades) {
      const now = new Date();
      const twentyFourHoursAgo = new Date(now.getTime() - (24 * 60 * 60 * 1000));
      
      const recentTrades = trades.filter(trade => 
        new Date(trade.ledger_close_time) >= twentyFourHoursAgo
      );
      
      if (recentTrades.length === 0) {
        return {
          volume: 0,
          high: 0,
          low: 0,
          change: 0,
          changePercent: 0
        };
      }
      
      let volume = 0;
      let high = 0;
      let low = Infinity;
      let prices = [];
      
      recentTrades.forEach(trade => {
        const price = parseFloat(trade.price.n / trade.price.d);
        const amount = parseFloat(trade.base_amount);
        
        volume += amount;
        
        if (price > high) high = price;
        if (price < low) low = price;
        
        prices.push({
          price: price,
          time: new Date(trade.ledger_close_time)
        });
      });
      
      // Sort prices by time to get first and last price
      prices.sort((a, b) => a.time - b.time);
      
      const firstPrice = prices.length > 0 ? prices[0].price : 0;
      const lastPrice = prices.length > 0 ? prices[prices.length - 1].price : 0;
      const change = lastPrice - firstPrice;
      const changePercent = firstPrice > 0 ? (change / firstPrice) * 100 : 0;
      
      return {
        volume: volume,
        high: high,
        low: low === Infinity ? 0 : low,
        change: change,
        changePercent: changePercent
      };
    }

    // Create price chart with real data
    async function createRealPriceChart(timeframe = '1D') {
      const trades = await fetchTradeHistory(500); // Get more trades for different timeframes
      const ctx = document.getElementById('priceChart').getContext('2d');
      
      // Filter trades based on timeframe
      const now = new Date();
      let filteredTrades = [];
      let timeLabels = [];
      
      switch(timeframe) {
        case '1D':
          const oneDayAgo = new Date(now.getTime() - (24 * 60 * 60 * 1000));
          filteredTrades = trades.filter(trade => 
            new Date(trade.ledger_close_time) >= oneDayAgo
          );
          timeLabels = filteredTrades.map(trade => 
            new Date(trade.ledger_close_time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
          );
          break;
          
        case '1W':
          const oneWeekAgo = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
          filteredTrades = trades.filter(trade => 
            new Date(trade.ledger_close_time) >= oneWeekAgo
          );
          // Group by day and calculate average price per day
          const dailyPrices = {};
          filteredTrades.forEach(trade => {
            const date = new Date(trade.ledger_close_time).toLocaleDateString();
            const price = parseFloat(trade.price.n / trade.price.d);
            
            if (!dailyPrices[date]) {
              dailyPrices[date] = { total: 0, count: 0 };
            }
            
            dailyPrices[date].total += price;
            dailyPrices[date].count += 1;
          });
          
          filteredTrades = Object.keys(dailyPrices).map(date => ({
            price: dailyPrices[date].total / dailyPrices[date].count,
            date: date
          }));
          
          timeLabels = Object.keys(dailyPrices);
          break;
          
        case '1M':
          const oneMonthAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
          filteredTrades = trades.filter(trade => 
            new Date(trade.ledger_close_time) >= oneMonthAgo
          );
          // Group by week and calculate average price per week
          const weeklyPrices = {};
          filteredTrades.forEach(trade => {
            const date = new Date(trade.ledger_close_time);
            const week = `Week ${Math.ceil(date.getDate() / 7)}`;
            const price = parseFloat(trade.price.n / trade.price.d);
            
            if (!weeklyPrices[week]) {
              weeklyPrices[week] = { total: 0, count: 0 };
            }
            
            weeklyPrices[week].total += price;
            weeklyPrices[week].count += 1;
          });
          
          filteredTrades = Object.keys(weeklyPrices).map(week => ({
            price: weeklyPrices[week].total / weeklyPrices[week].count,
            week: week
          }));
          
          timeLabels = Object.keys(weeklyPrices);
          break;
          
        case 'ALL':
        default:
          filteredTrades = trades;
          timeLabels = filteredTrades.map(trade => 
            new Date(trade.ledger_close_time).toLocaleDateString()
          );
          break;
      }
      
      const prices = filteredTrades.map(trade => 
        typeof trade.price === 'number' ? trade.price : parseFloat(trade.price.n / trade.price.d)
      );
      
      // Destroy existing chart if it exists
      if (priceChart) {
        priceChart.destroy();
      }
      
      // If we don't have enough data, show the Stellar.expert iframe
      if (prices.length < 2) {
        // Hide the canvas
        ctx.canvas.style.display = 'none';
        
        return;
      }
      
      priceChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: timeLabels,
          datasets: [{
            label: 'LAAM/XLM Price',
            data: prices,
            borderColor: '#1976d2',
            backgroundColor: 'rgba(25, 118, 210, 0.1)',
            borderWidth: 2,
            pointRadius: 2,
            pointBackgroundColor: '#1976d2',
            pointBorderColor: '#fff',
            pointHoverRadius: 4,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(0, 0, 0, 0.7)',
              titleFont: {
                size: 14
              },
              bodyFont: {
                size: 13
              },
              callbacks: {
                label: function(context) {
                  return `Price: ${context.parsed.y.toFixed(7)} XLM`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              },
              ticks: {
                maxRotation: 0,
                autoSkip: true,
                maxTicksLimit: 6
              }
            },
            y: {
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              ticks: {
                callback: function(value) {
                  return value.toFixed(6) + ' XLM';
                }
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index',
          }
        }
      });
    }

    // Update overview tab with real data
    async function updateOverview() {
      try {
        // Fetch current price
        const priceData = await fetchLaamPrice();
        const currentPrice = priceData.price;
        
        // Fetch trade history for stats
        const trades = await fetchTradeHistory(200);
        const stats = calculate24hStats(trades);
        
        // Update price display
        document.getElementById('overviewLaamPriceXLM').textContent = currentPrice.toFixed(7);
        
        // Update price change
        const priceChangeElement = document.getElementById('priceChange');
        const changeSign = stats.change >= 0 ? '+' : '';
        priceChangeElement.textContent = `${changeSign}${stats.change.toFixed(7)} (${changeSign}${stats.changePercent.toFixed(2)}%)`;
        priceChangeElement.className = stats.change >= 0 ? 'price-change positive' : 'price-change negative';
        
        // Update market stats
        document.getElementById('volume24h').textContent = `${stats.volume.toFixed(2)} Laam`;
        document.getElementById('high24h').textContent = `${stats.high.toFixed(7)} XLM`;
        document.getElementById('low24h').textContent = `${stats.low.toFixed(7)} XLM`;
        
        // Calculate market cap (current price * max supply)
        const marketCap = currentPrice * LAAM_TOKEN.maxSupply;
        document.getElementById('marketCap').textContent = `${marketCap.toFixed(0)} XLM`;
        
        // Create or update the price chart
        const activeTimeframe = document.querySelector('.timeframe-btn.active').getAttribute('data-timeframe');
        await createRealPriceChart(activeTimeframe);
        
      } catch (error) {
        console.error('Error updating overview:', error);
        
        // Fallback values in case of error
        document.getElementById('overviewLaamPriceXLM').textContent = '0.060000';
        document.getElementById('priceChange').textContent = 'Error loading data';
        document.getElementById('volume24h').textContent = '0 Laam';
        document.getElementById('high24h').textContent = '0.000000 XLM';
        document.getElementById('low24h').textContent = '0.000000 XLM';
        document.getElementById('marketCap').textContent = '0 XLM';
        
        createPriceChart(); // Fallback to sample chart
      }
      }
      function openSendWizard(asset) {
  console.log("Open send wizard for:", asset);
  // halkan waxaad ku xiri kartaa wizard-kii send
      }
  function showStep(step){
    for(let i=1;i<=4;i++) document.getElementById("step"+i).style.display="none";
    if(step>=1) document.getElementById("step"+step).style.display="block";
    if(step===4){
      document.getElementById("confirmAsset").textContent = document.getElementById("sendAsset").value;
      document.getElementById("confirmAmount").textContent = document.getElementById("sendAmount").value;
      document.getElementById("confirmDest").textContent = document.getElementById("sendDest").value;
      document.getElementById("confirmMemo").textContent = document.getElementById("sendMemo").value || "";
    }
  }
  function nextStep(step){ showStep(step); }
  function backStep(step){
    if(step<1){
      document.getElementById("sendWizard").style.display="none";
      document.getElementById("wizardOverlay").style.display="none";
    } else showStep(step);
  }

  // Open wizard
  document.getElementById("btnSend").onclick = function(){
    document.getElementById("sendWizard").style.display="block";
    document.getElementById("wizardOverlay").style.display="block";
    showStep(1);
  }
  // Close wizard
  document.getElementById("wizardOverlay").onclick = closeWizard;
  document.getElementById("wizardClose").onclick = closeWizard;

  function closeWizard(){
    document.getElementById("sendWizard").style.display="none";
  }

  // Send Transaction
  async function sendTransaction(){
    const asset = document.getElementById("sendAsset").value;
    const amount = document.getElementById("sendAmount").value;
    const destination = document.getElementById("sendDest").value;
    const memo = document.getElementById("sendMemo").value;

    const btn = document.getElementById("confirmSendBtn");
    btn.textContent = "Sending...";
    btn.disabled = true;

    try {
      const account = await server.loadAccount(currentKeypair.publicKey());

      let operation;
      if(asset === "XLM"){
        operation = StellarSdk.Operation.payment({
          destination, asset: StellarSdk.Asset.native(), amount
        });
      } else if(asset === "LAAM"){
        operation = StellarSdk.Operation.payment({
          destination, asset: LAAM_ASSET, amount
        });
      } else if(asset === "USDC"){
        operation = StellarSdk.Operation.payment({
          destination, asset: USDC_ASSET, amount
        });
      }

      const txBuilder = new StellarSdk.TransactionBuilder(account, {
        fee: StellarSdk.BASE_FEE,
        networkPassphrase: StellarSdk.Networks.PUBLIC
      });

      if(memo){ txBuilder.addMemo(StellarSdk.Memo.text(memo)); }

      const transaction = txBuilder.addOperation(operation).setTimeout(180).build();
      transaction.sign(currentKeypair);

      const result = await server.submitTransaction(transaction);

     showSuccess('Transaction sent successfully!');
      closeWizard();

    } catch(err){
      console.error("Send error:", err);
      alert(" Failed: " + err.message);
    } finally {
      btn.textContent = "Send Now";
      btn.disabled = false;
    }
  }


// Add pair selector to trade section
function addPairSelector() {
  const tradeHeader = document.querySelector('.trade-header');
  if (!tradeHeader) return;
  
  // Create pair selector
  const pairSelector = document.createElement('div');
  pairSelector.className = 'pair-selector';
  pairSelector.innerHTML = `
    <select id="tradePairSelect" style="background: black; color: white; border: 1px solid var(--line); border-radius: 8px; padding: 8px 12px; font-size: 14px;">
      <option value="LAAM_XLM">LAAM/XLM</option>
      <option value="USDC_XLM">USDC/XLM</option>
      <option value="LAAM_USDC">LAAM/USDC</option>
    </select>
  `;
  
  // Insert after trade header
  tradeHeader.parentNode.insertBefore(pairSelector, tradeHeader.nextSibling);
  
  // Add event listener
  document.getElementById('tradePairSelect').addEventListener('change', function() {
    switchTradePair(this.value);
  });
}

// Initialize trading pairs when DOM loads
document.addEventListener('DOMContentLoaded', function() {
  // Add pair selector
  addPairSelector();
  
  // Initialize USDC asset
  if (typeof StellarSdk !== 'undefined') {
    USDC_ASSET = new StellarSdk.Asset(USDC_TOKEN.code, USDC_TOKEN.issuer);
  }
  
  // Set default pair
  switchTradePair('LAAM_XLM');
});
//Enhanced swap function for multiple pairs
function swapTradeAssets() {
  switch(currentTradePair) {
    case 'LAAM_XLM':
      switchTradePair('USDC_XLM');
      break;
    case 'USDC_XLM':
      switchTradePair('LAAM_USDC');
      break;
    case 'LAAM_USDC':
      switchTradePair('LAAM_XLM');
      break;
  }
}

// Update the swap icon event listener
document.addEventListener('DOMContentLoaded', function() {
  const swapIcon = document.getElementById('swapAssets');
  if (swapIcon) {
    swapIcon.addEventListener('click', swapTradeAssets);
  }
});

function showStep(step){
  for(let i=1;i<=6;i++){
    const s = document.getElementById("step"+i);
    if(s) s.style.display="none";
  }
  currentStep = step;

  // Update confirmation fields for step 5
  if(step===5){
    document.getElementById("confirmAsset").textContent = document.getElementById("sendAsset").value;
    document.getElementById("confirmAmount").textContent = document.getElementById("sendAmount").value;
    document.getElementById("confirmDest").textContent = document.getElementById("sendDest").value;
    document.getElementById("confirmMemo").textContent = document.getElementById("sendMemo").value || "";
  }

  document.getElementById("step"+step).style.display="block";
}

// Next step
function nextStep(step){
  const errorBox = document.getElementById("wizardError");
  errorBox.style.display = "none";

  if(step===2){
    let asset = document.getElementById("sendAsset").value;
    if(!asset){
      errorBox.textContent = "Please select an asset";
      errorBox.style.display = "block";
      return;
    }
  }

  if(step===3){
    let amount = document.getElementById("sendAmount").value;
    if(!amount || parseFloat(amount)<=0){
      errorBox.textContent = "Please enter amount";
      errorBox.style.display = "block";
      return;
    }
  }

  if(step===4){
    let dest = document.getElementById("sendDest").value.trim();
    if(!dest){
      errorBox.textContent = "Please enter destination address";
      errorBox.style.display = "block";
      return;
    }
  }

  showStep(step);
}

// Open wizard
document.getElementById("btnSend").onclick = function(){
  document.getElementById("sendWizard").style.display="block";
  document.getElementById("wizardOverlay").style.display="block";
  showStep(1);
}

// Close wizard
document.getElementById("wizardOverlay").onclick = closeWizard;
document.getElementById("wizardClose").onclick = closeWizard;

function closeWizard(){
  document.getElementById("sendWizard").style.display="none";
  document.getElementById("wizardOverlay").style.display="none";
  document.getElementById("wizardError").style.display="none";
}

// Toast notification
function showToast(message, duration = 2000){
  const toast = document.createElement('div');
  toast.textContent = message;
  toast.style.background = '#1a73e8'; // Blue like buttons
  toast.style.color = '#fff';
  toast.style.padding = '10px 15px';
  toast.style.borderRadius = '12px';
  toast.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
  toast.style.fontSize = '14px';
  toast.style.opacity = '0';
  toast.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
  toast.style.transform = 'translateY(-10px)';

  document.getElementById('toastContainer').appendChild(toast);

  requestAnimationFrame(() => {
    toast.style.opacity = '1';
    toast.style.transform = 'translateY(0)';
  });

  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateY(-10px)';
    toast.addEventListener('transitionend', ()=> toast.remove());
  }, duration);
}

// Copy helper using toast
function copyToClipboard(elementId){
  try {
    const text = document.getElementById(elementId).textContent;

    if(navigator.clipboard && window.isSecureContext){
      navigator.clipboard.writeText(text).then(()=>{
        showToast(`Copied: ${text}`);
      }).catch(err=>{
        fallbackCopy(text);
      });
    } else {
      fallbackCopy(text);
    }

  } catch(err){
    console.error("Copy error:", err);
    showToast("Copy failed!");
  }
}

function fallbackCopy(text){
  const textarea = document.createElement("textarea");
  textarea.value = text;
  document.body.appendChild(textarea);
  textarea.select();
  textarea.setSelectionRange(0, 99999);
  const successful = document.execCommand('copy');
  document.body.removeChild(textarea);
  if(successful){
    showToast(`Copied: ${text}`);
  } else {
    showToast("Copy failed!");
  }
}

// Send Transaction update
async function sendTransaction(){
  const asset = document.getElementById("sendAsset").value;
  const amount = document.getElementById("sendAmount").value;
  const destination = document.getElementById("sendDest").value;
  const memo = document.getElementById("sendMemo").value;

  const btn = document.getElementById("confirmSendBtn");
  btn.textContent = "Sending...";
  btn.disabled = true;

  try {
    const account = await server.loadAccount(currentKeypair.publicKey());

    let operation;
    if(asset === "XLM"){
      operation = StellarSdk.Operation.payment({
        destination, asset: StellarSdk.Asset.native(), amount
      });
    } else if(asset === "LAAM"){
      operation = StellarSdk.Operation.payment({
        destination, asset: LAAM_ASSET, amount
      });
    } else if(asset === "USDC"){
      operation = StellarSdk.Operation.payment({
        destination, asset: USDC_ASSET, amount
      });
    }

    const txBuilder = new StellarSdk.TransactionBuilder(account, {
      fee: StellarSdk.BASE_FEE,
      networkPassphrase: StellarSdk.Networks.PUBLIC
    });

    if(memo){ txBuilder.addMemo(StellarSdk.Memo.text(memo)); }

    const transaction = txBuilder.addOperation(operation).setTimeout(180).build();
    transaction.sign(currentKeypair);

    const result = await server.submitTransaction(transaction);

    // Populate receipt
    document.getElementById("receiptDest").textContent = destination;

    // Txid link to Stellar Expert
    const txLink = `https://stellar.expert/explorer/public/tx/${result.hash}`;
    const receiptHashEl = document.getElementById("receiptHash");
    receiptHashEl.textContent = result.hash;
    receiptHashEl.href = txLink;

    document.getElementById("receiptAmount").textContent = `${amount} ${asset}`;

    const now = new Date();
    const formattedDate = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
    document.getElementById("receiptDate").textContent = formattedDate;

    showStep(6);

  } catch(err){
    console.error("Send error:", err);
    alert(" Failed: " + err.message);
  } finally {
    btn.textContent = "Send Now";
    btn.disabled = false;
  }
}


document.getElementById('fingerprintUnlockBtn').addEventListener('click', async () => {
  const success = await fingerprintAuth.authenticate();
  if (success) {
    console.log('Fingerprint unlock successful');
  }
});
// Enhanced openTokenModal function
function openTokenModal(token) {
  selectedToken = token;
  
  // Set modal content based on token
  const modalTokenName = document.getElementById('modalTokenName');
  const modalTokenIcon = document.getElementById('modalTokenIcon');
  const modalTokenBalance = document.getElementById('modalTokenBalance');
  const modalTokenValue = document.getElementById('modalTokenValue');
  const trustlineBtn = document.getElementById('tokenModalTrustlineBtn');
  
  // Set token details
  modalTokenName.textContent = token;
  
  // Set token icon
  if (token === 'XLM') {
    modalTokenIcon.src = 'https://res.coinpaper.com/coinpaper/stellar_xlm_logo_07021d63c0.png';
  } else if (token === 'LAAM') {
    modalTokenIcon.src = 'https://i.ibb.co/r28SP1bN/20250802-225108.png';
  } else if (token === 'USDC') {
    modalTokenIcon.src = 'https://i.ibb.co/r2qNFs22/images-2.png';
  }
  
  // Set token balance and value
  const balanceElement = document.getElementById(token.toLowerCase() + 'Bal');
  const valueElement = document.getElementById(token.toLowerCase() + 'BalUsd');
  
  modalTokenBalance.textContent = balanceElement ? balanceElement.textContent + ' ' + token : '0 ' + token;
  modalTokenValue.textContent = valueElement ? '$' + valueElement.textContent : '$0.00';
  
  // Show or hide trustline button based on token
  if (trustlineBtn) {
    if (token === 'XLM') {
      trustlineBtn.classList.add('hidden');
    } else {
      trustlineBtn.classList.remove('hidden');
    }
  }
  
  // Show modal
  document.getElementById('tokenModal').classList.add('show');
}

function closeTokenModal() {
  document.getElementById('tokenModal').classList.remove('show');
  selectedToken = null;
}

// Add Trustline for selected token
async function addTrustlineForToken() {
  if (!selectedToken) {
    showError('No token selected');
    return;
  }
  
  if (selectedToken === 'XLM') {
    showError('XLM is a native asset and does not require a trustline.');
    return;
  }
  
  let asset;
  if (selectedToken === 'LAAM') {
    asset = LAAM_ASSET;
  } else if (selectedToken === 'USDC') {
    asset = USDC_ASSET;
  } else {
    showError('Unknown token');
    return;
  }
  
  await addTrustline(asset);
}

// Enhanced addTrustline function
async function addTrustline(asset) {
  if (!currentKeypair) {
    showError('Wallet not loaded.');
    return;
  }
  
  const trustlineBtn = document.getElementById('tokenModalTrustlineBtn');
  const originalText = trustlineBtn.innerHTML;
  
  try {
    trustlineBtn.innerHTML = '<div class="loading-spinner" style="width: 20px; height: 20px;"></div>';
    trustlineBtn.disabled = true;
    
    const account = await server.loadAccount(currentKeypair.publicKey());
    
    const transaction = new StellarSdk.TransactionBuilder(account, {
      fee: StellarSdk.BASE_FEE,
      networkPassphrase: StellarSdk.Networks.PUBLIC
    })
    .addOperation(StellarSdk.Operation.changeTrust({
      asset: asset
    }))
    .setTimeout(180)
    .build();
    
    transaction.sign(currentKeypair);
    
    const result = await server.submitTransaction(transaction);
    
    showSuccess('Trustline added successfully!');
    closeTokenModal();
    
    // Refresh balances
    await updateBalanceDisplay();
    
  } catch (error) {
    console.error('Add trustline error:', error);
    
    if (error.response && error.response.data && error.response.data.extras && error.response.data.extras.result_codes) {
      if (error.response.data.extras.result_codes.operations.includes('op_underfunded')) {
        showError('Insufficient XLM balance to add trustline. You need at least 1 XLM for the transaction fee and trustline reserve.');
      } else if (error.response.data.extras.result_codes.operations.includes('op_already_exists')) {
        showError('Trustline already exists for this asset.');
      } else {
        showError('Failed to add trustline: ' + error.message);
      }
    } else {
      showError('Failed to add trustline: ' + error.message);
    }
  } finally {
    trustlineBtn.innerHTML = originalText;
    trustlineBtn.disabled = false;
  }
}

// Open Send Wizard for selected token
function openSendWizardForToken() {
  if (selectedToken) {
    // Set the asset in send wizard
    document.getElementById('sendAsset').value = selectedToken;
    closeTokenModal();
    
    // Open send wizard
    document.getElementById('sendWizard').style.display = 'block';
    document.getElementById('wizardOverlay').style.display = 'block';
    showStep(1);
  }
}

// Open Receive for selected token
function openReceiveForToken() {
  closeTokenModal();
  
  // Show receive address modal
  const publicKey = currentKeypair ? currentKeypair.publicKey() : "GB7WZHXV4FCATLV2LZFLYU7A74BD5WALPUMOU4CY4DRJGJIL3EW3DGXA";

  const receiveModal = document.createElement('div');
  receiveModal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
  `;

  receiveModal.innerHTML = `
      <div style="background: white; padding: 25px; border-radius: 20px; text-align: center; max-width: 320px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
          <h3 style="color: #1976d2; margin-top: 0; margin-bottom: 20px;">Receive ${selectedToken}</h3>
          <div style="background: white; padding: 15px; margin: 15px 0; border-radius: 12px; border: 1px solid #e0e0e0;">
              <img src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${publicKey}" 
                   alt="QR Code" style="max-width: 180px; border-radius: 8px;">
          </div>
          <div style="font-size: 14px; color: #666; margin-bottom: 10px;">Scan this QR code or copy the address below</div>
          <div id="publicKeyText" class="mono" 
               style="font-size: 13px; margin: 15px 0; padding: 12px; background: #f8f9fa; border-radius: 12px; word-break: break-all; line-height: 1.5;">
              ${publicKey}
          </div>
          <button id="btnCopy" 
                  style="background: #4caf50; color: white; border: none; padding: 10px 22px; 
                         border-radius: 12px; cursor: pointer; font-weight: 600; margin-top: 10px; margin-right: 10px;">
              Copy
          </button>
          <button onclick="this.parentElement.parentElement.remove()" 
                  style="background: #1976d2; color: white; border: none; padding: 12px 24px; 
                         border-radius: 12px; cursor: pointer; font-weight: 600; margin-top: 10px;">
                  
          </button>
      </div>
  `;

  document.body.appendChild(receiveModal);

  // Add event listener to the Copy button
  document.getElementById("btnCopy").addEventListener("click", function () {
      copyToClipboard("publicKeyText");
  });
}
    function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                alert('Copied to clipboard!');
            }, function(err) {
                console.error('Could not copy text: ', err);
            });
        }
        
        function closeReceipt() {
            // In a real application, this would close the receipt
            alert('Receipt closed. In a real app, this would navigate away or close the modal.');
        }
// ===== Receipt Modal Functions =====
function openReceiptModal(giveAmount, giveAsset, getAmount, getAsset, exchangeRate, transactionHash) {
  // Populate receipt data
  document.getElementById("receiptGive").textContent = `${giveAmount} ${giveAsset}`;
  document.getElementById("receiptGet").textContent = `${getAmount} ${getAsset}`;
  document.getElementById("receiptRate").textContent = `1 ${giveAsset} = ${exchangeRate} ${getAsset}`;
  
  // Store transaction hash for viewing details
  document.getElementById("receiptModal").setAttribute('data-transaction-hash', transactionHash);
  
  // Show receipt modal
  document.getElementById("receiptModal").classList.add("show");
}

function closeReceiptModal() {
  document.getElementById("receiptModal").classList.remove("show");
}

function viewTransactionDetails() {
  const transactionHash = document.getElementById("receiptModal").getAttribute('data-transaction-hash');
  if (transactionHash) {
    // Open transaction in Stellar Expert
    window.open(`https://stellar.expert/explorer/public/tx/${transactionHash}`, '_blank');
  }
}

function closeAndRefresh() {
  closeReceiptModal();
  // Refresh balances after successful swap
  updateBalanceDisplay();
}

// ===== Enhanced Execute Swap Function with Receipt =====
async function executeSwap() {
  const giveAmount = parseFloat(document.getElementById("giveAmount").value);
  const giveAssetCode = document.getElementById("giveAsset").value;
  const getAssetCode = document.getElementById("getAsset").value;
  const getAmount = parseFloat(document.getElementById("getAmount").value);

  if (!giveAmount || giveAmount <= 0) {
    showError("Enter amount to swap");
    return;
  }

  if (!currentKeypair) {
    showError("Wallet not loaded");
    return;
  }

  const confirmBtn = document.getElementById("confirmSwapBtn");
  const originalText = confirmBtn.textContent;

  try {
    confirmBtn.textContent = "Swapping...";
    confirmBtn.disabled = true;

    const giveAsset = getAssetByCode(giveAssetCode);
    const getAsset = getAssetByCode(getAssetCode);
    const account = await server.loadAccount(currentKeypair.publicKey());

    // 1 Hel path-ka ugu fiican ee AMM
    const pathResponse = await server
      .strictSendPaths(giveAsset, giveAmount.toString(), [getAsset])
      .call();

    if (!pathResponse.records || pathResponse.records.length === 0) {
      showError("No AMM liquidity path found between " + giveAssetCode + " and " + getAssetCode);
      confirmBtn.textContent = originalText;
      confirmBtn.disabled = false;
      return;
    }

    // 2 Qaado path AMM-ka ugu fiican
    const bestPath = pathResponse.records[0];
    const destMin = (parseFloat(bestPath.destination_amount) * 0.98).toFixed(7); // 2% slippage

    // 3 Dhis transaction-ka AMM Swap
    const transaction = new StellarSdk.TransactionBuilder(account, {
      fee: StellarSdk.BASE_FEE,
      networkPassphrase: StellarSdk.Networks.PUBLIC,
    })
      .addOperation(
        StellarSdk.Operation.pathPaymentStrictSend({
          sendAsset: giveAsset,
          sendAmount: giveAmount.toString(),
          destination: currentKeypair.publicKey(),
          destAsset: getAsset,
          destMin: destMin,
          path: bestPath.path.map((p) =>
            p.asset_type === "native"
              ? StellarSdk.Asset.native()
              : new StellarSdk.Asset(p.asset_code, p.asset_issuer)
          ),
        })
      )
      .setTimeout(180)
      .build();

    transaction.sign(currentKeypair);
    const result = await server.submitTransaction(transaction);

    closeSwapModal();

    // 4 Update receipt modal
    const exchangeRate = (getAmount / giveAmount).toFixed(7);
    openReceiptModal(
      giveAmount.toFixed(7),
      giveAssetCode,
      getAmount.toFixed(7),
      getAssetCode,
      exchangeRate,
      result.hash
    );
  } catch (error) {
    console.error("Swap failed:", error);
    if (error.response?.data?.extras) {
      const resultCodes = error.response.data.extras.result_codes;
      if (resultCodes.operations?.includes("op_underfunded"))
        showError("Insufficient balance for this swap");
      else if (resultCodes.operations?.includes("op_no_trust"))
        showError("Trustline required for " + getAssetCode);
      else if (resultCodes.operations?.includes("op_line_full"))
        showError("Trustline limit reached for " + getAssetCode);
      else showError("Swap failed: " + error.message);
    } else {
      showError("Swap failed: " + error.message);
    }
  } finally {
    confirmBtn.textContent = originalText;
    confirmBtn.disabled = false;
  }
}

// ===== Receipt Modal Initialization =====
(function(){
  const modal = document.getElementById('receiptModal');
  const giveEl = document.getElementById('receiptGive');
  const getEl = document.getElementById('receiptGet');
  const rateEl = document.getElementById('receiptRate');
  const hashEl = document.getElementById('receiptHash');
  const timeEl = document.getElementById('receiptTime');

  window.openReceiptModal = function(giveAmount, giveAsset, getAmount, getAsset, rate, hash) {
    giveEl.textContent = `${giveAmount} ${giveAsset}`;
    getEl.textContent = `${getAmount} ${getAsset}`;
    rateEl.textContent = `1 ${giveAsset} = ${rate} ${getAsset}`;
    hashEl.textContent = hash || '';
    timeEl.textContent = new Date().toISOString();

    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');

    // Re-play check animation
    const check = modal.querySelector('.check');
    if (check) {
      check.style.animation = 'none';
      void check.offsetWidth;
      check.style.animation = '';
    }
  };

  window.closeReceiptModal = function(){
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden','true');
  };

  window.viewTransactionDetails = function(){
    const hash = hashEl.textContent.trim();
    if (!hash || hash === '') return alert('Transaction hash not available.');
    window.open(`https://stellar.expert/explorer/public/tx/${encodeURIComponent(hash)}`, '_blank', 'noopener');
  };

  window.copyTx = function(){
    const hash = hashEl.textContent.trim();
    if (!hash || hash === '') return;
    navigator.clipboard?.writeText(hash).then(()=>{
      const btn = document.querySelector('.meta-copy');
      btn.textContent = 'Copied';
      setTimeout(()=> btn.textContent = 'Copy', 1400);
    }).catch(()=> alert('Copy failed  select and copy manually.'));
  };

  window.closeAndRefresh = function(){
    closeReceiptModal();
    if (typeof refreshBalances === 'function') refreshBalances();
  };

  document.addEventListener('keydown', (e) => {
    if(e.key === 'Escape' && modal.classList.contains('show')) closeReceiptModal();
  });

  document.querySelector('.receipt-card')?.addEventListener('click', e => e.stopPropagation());
})();
</script>
</script>
</body>
</html>
